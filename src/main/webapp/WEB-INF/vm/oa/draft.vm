#set($layout = "layout/oa_layout.vm")
<style type="text/css">
    td input {
        width: 100%;
        text-align: center;
        color: red;
        font-size: larger;
    }

    td {
        text-align: center;
    }

</style>

<div class="row">
    <div class="col-xs-12">
        <div class="widget-box">
            <div class="widget-header header-color-blue" style="">
                <h5 class="bigger lighter"><i class="icon-time"></i>草稿列表</h5>
            </div>
            <div class="widget-body">
                <table id="draft"
                       class="table table-striped table-bordered table-hover"></table>
            </div>
        </div>

    </div>
</div>

<div id="dialog-confirm" class="hide">
    <form class="form-horizontal">
        <div id="edit-form">
            <div id="edit_content">
            </div>
        </div>
    </form>
</div>

<div id="common-notice-dialog" class="hide"></div>

<script src="static/js/utils.js">
</script>
<script src="static/js/dialog_common.js">
</script>
<script src="static/ace/js/jquery.dataTables.min.js">
</script>
<script src="static/ace/js/jquery.dataTables.bootstrap.js">
</script>
<script src="static/js/all_common.js">
</script>
<script src="/oaengine/static/My97DatePicker/WdatePicker.js"></script>
<script language=JavaScript>

    jQuery(function ($) {
        window.edit_form = $("#edit-form").html();
        showDraftInfo("oa/draft", "draft");
    });
    function showTime() {
        WdatePicker({dateFmt: 'yyyy-MM-dd HH:mm:ss'});
    }

    //显示表格数据
    function showDraftInfo(url, tableName) {
        var ex = document.getElementById(tableName);
        if ($.fn.dataTable.fnIsDataTable(ex)) {
            $(ex).dataTable().fnDestroy();
        }
        var aoColumns = [{
            "sTitle": "ID",
            "sWidth": 100,
            "sClass": "center",
            "bVisible": false
        }, {
            "sTitle": "员工编号",
            "sWidth": 150,
            "sClass": "center"
        }, {
            "sTitle": "部门",
            "sWidth": 300,
            "sClass": "center"
        }, {
            "sTitle": "姓名",
            "sWidth": 150,
            "sClass": "center"
        }, {
            "sTitle": "申请日期",
            "sWidth": 200,
            "sClass": "center"
        }, {
            "sTitle": "报销金额",
            "sWidth": 150,
            "sClass": "center"
        }, {
            "sTitle": "编辑",
            "sWidth": 150,
            "sClass": "center"
        }];
        var wh = $(window).height();
        var sY = (wh - 100) + 'px';
        var oTable = $(ex).dataTable({
            "bFilter": false,
            "bAutoWidth": true,
            "bProcessing": false,
            "bServerSide": true,
            "sDom": 't<"row"<"col-sm-12"i>>',
            "bSort": false,
            "bScrollCollapse": true,
            "iDisplayLength": 20,
            "iDisplayStart": 0,
            "aoColumns": aoColumns,
            "sAjaxSource": "",
            "bScrollInfinite": true,
            "sScrollY": sY,
            "fnServerData": function (sSource, aDataSet, fnCallback) {
                var start = 0;
                var length = 0;
                for (var i = 0; i < aDataSet.length; i++) {
                    if (aDataSet[i].name == 'iDisplayStart') {
                        start = aDataSet[i].value;
                    }
                    if (aDataSet[i].name == 'iDisplayLength') {
                        length = aDataSet[i].value;
                    }
                }
                var vars = {};
                vars["start"] = start;
                vars["length"] = length;
                var params = {};
                params["vars"] = vars;
                $.ajax({
                    "contentType": "application/json; charset=utf-8",
                    "type": "POST",
                    "url": url,
                    "data": JSON.stringify(params),
                    "success": function (resp) {
                        if (resp.errorCode == 0) {
                            var data = resp.data;
                            var iTotalRecords = data.count || 0;
                            var iTotalDisplayRecords = iTotalRecords;
                            var aaData = showDraftTableInfo(data);
                            data = {
                                "aaData": aaData,
                                "iTotalRecords": (iTotalRecords || 0),
                                "iTotalDisplayRecords": (iTotalDisplayRecords || 0)
                            };
                            fnCallback(data);
                        } else {
                            showCommonNoticeDialog('失败', 'icon-warning-sign',
                                    generateNoticeMsg(resp.errorMessage), 300);
                        }
                    },
                    error: function () {
                        showCommonNoticeDialog('网络错误', 'icon-bolt', generateNoticeMsg('网络错误，请刷新后重试!'), 300);
                    }
                });
            },
            "fnDrawCallback": function () {
                if (!oTable) {
                    return;
                }

                $("#search").unbind("click");
                $("#search").on("click", function (e) {
                    showInfo(url, tableName, rTableId, status);
                }).on("dblclick", function (e) {
                    e.preventDefault();
                });
                oTable.$('tr.row_selected').removeClass('row_selected');
                oTable.$("tr").unbind('click');
                oTable.$("tr").click({
                    oTable: oTable
                }, function (e) {
                    if ($(this).hasClass('row_selected')) {
                        $(this).removeClass('row_selected');
                    }
                    else {
                        e.data.oTable.$('tr.row_selected').removeClass('row_selected');
                        $(this).addClass('row_selected');
                        var id = e.data.oTable.fnGetData(this)[0];
//                        showApplyTodoOrHistoryDetailsList(id, rTableId, status);
                    }
                });
            }
        })
    }

    function showDraftTableInfo(data) {
        var aaData = [];
        var needData = data.tableInfos;
        var d_len = needData.length;
        for (var i = 0; i < d_len; i++) {
            var money = parseFloat(needData[i][5]);
            money /= 100;
            var map = $.parseStr("<a href='javascript:void(0);' " +
            "onclick='skipEditDraftInfo(%s);'><i class='icon-link'></i></a>", needData[i][0]);

            var push = "";

            aaData.push([needData[i][0], needData[i][1],
                needData[i][2], needData[i][3], needData[i][4], money.toFixed(2), map]);

        }
        return aaData;
    }

    function skipEditDraftInfo(formId){
//        window.location.href="/apply.html?formId=encodeURIComponent("+formId+")";
        window.location.href="oa/apply.html?formId="+formId;
    }


</script>
