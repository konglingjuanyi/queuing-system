#set($layout = "layout/oa_layout.vm")
<style type="text/css">
    td input {
        width: 100%;
        text-align: center;
        color: red;
        font-size: larger;
    }
    
    td {
        text-align: center;
    }
    
</style>
<div class="row">
    <div class="col-xs-12">
        <iframe style="display:none" name="export">
        </iframe>
        <form id="form1" action="/user/?do=export" target="export" method="POST">
            <div class="form-group dash-button-group">
                <input type="button" id="today" class="btn btn-minier btn-success" value="今天"><input type="button" id="week" class="btn btn-minier btn-warning" value="本周"><input type="button" id="last_month" class="btn btn-minier btn-info" value="上月"><input type="button" id="month" class="btn btn-minier btn-pink" value="本月"><span class="input-icon input-icon-right"><input name="start_date" id="card-date-from" type="text"><i class="icon-calendar green"></i></span>
                <span class="input-icon input-icon-right"><input name="end_date" id="card-date-to" type="text"><i class="icon-calendar green"></i></span>
                <input id="card-display-name" type="hidden" value=""><input id="is-plus" type="checkbox">
                <label for="is-plus">
                    是否加班
                </label>
                <input type="button" id="search" class="btn btn-minier btn-primary" value="查询"><input onclick="$('form1').submit()" type="submit" id="export" class="btn btn-minier btn-primary" value="导出"><input onclick="$('form1').submit()" type="submit" id="export_sub" name="sub" class="btn btn-minier btn-primary" value="导出下属">
            </div>
        </form>
    </div>
</div>
<div class="row">
    <div class="col-xs-12">
        <div class="table-header">
            申请报销信息
        </div>
        <div class="table-responsive" id="card_s">
            <div id="ems_table_wrapper" class="dataTables_wrapper" role="grid">
                <table id="apply_table" class="table table-striped table-bordered table-hover dataTable" aria-describedby="ems_table_info" style="width: 100%;">
                </table>
            </div>
        </div>
    </div>
</div>
<div id="dialog-confirm" class="hide">
    <form class="form-horizontal">
        <div id="edit-form">
            <div id="edit_content">
            </div>
        </div>
    </form>
</div>
<!--详情页模版-->
<div id="inner" style="display:none">
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-9" style="border:solid 1px; background-color: #f0f0f0;text-align: center;">
                <span style="font-size:18px">个人基本信息</span>
            </div>
            <table style="border-collapse:collapse;" border="1" class="col-xs-9" id="table">
                <tr>
                    <td>
                        申请人
                    </td>
                    <td>
                        <input type="text" readonly="readonly">
                    </td>
                    <td>
                        员工编号
                    </td>
                    <td>
                        <input type="text" readonly="readonly">
                    </td>
                    <td>
                        申请日期
                    </td>
                    <td>
                        <input type="text"style="color:red" readonly="readonly">
                    </td>
                </tr>
                <tr>
                    <td>
                        一级部门
                    </td>
                    <td>
                        <input type="text" readonly="readonly">
                    </td>
                    <td>
                        申请部门
                    </td>
                    <td>
                        <input type="text" readonly="readonly">
                    </td>
                    <td>
                        部门编号
                    </td>
                    <td>
                        <input type="text" readonly="readonly">
                    </td>
                </tr>
                <tr>
                    <td>
                        是否直接向VP汇报
                    </td>
                    <td>
                        <div id="vp">
                        </div>
                    </td>
                    <td>
                        银行卡号
                    </td>
                    <td>
                        <input type="text" readonly="readonly">
                    </td>
                    <td>
                        银行开户行
                    </td>
                    <td>
                        <input type="text" readonly="readonly">
                    </td>
                </tr>
                <tr>
                    <td>
                        是否有借款
                    </td>
                    <td>
                        <div id="bw">
                        </div>
                    </td>
                    <td>
                        借款单流水号
                    </td>
                    <td>
                        <input type="text" readonly="readonly">
                    </td>
                    <td>
                        借款金额
                    </td>
                    <td>
                        <input type="text" readonly="readonly">
                    </td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-9">
                <tr>
                    <td>
                        报销金额总计
                    </td>
                    <td>
                        <input type="text" value="0" id="sum" readonly="readonly">
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-9" style="border:solid 1px; background-color: #f0f0f0;text-align: center;">
                <span style="font-size:18px">出租车费明细(含汽车燃油费)</span>
            </div>
            <table style="border-collapse:collapse;" border="0" cellpadding="2" cellspacing="1" class="col-xs-9" id="table1">
                <tr>
                    <td bgcolor="#96E0E2">
                        日期
                    </td>
                    <td bgcolor="#96E0E2">
                        起点
                    </td>
                    <td bgcolor="#96E0E2">
                        终点
                    </td>
                    <td bgcolor="#96E0E2">
                        具体时间
                    </td>
                    <td bgcolor="#96E0E2">
                        用途
                    </td>
                    <td bgcolor="#96E0E2">
                        同行人(姓名)
                    </td>
                    <td bgcolor="#96E0E2">
                        工时
                    </td>
                    <td bgcolor="#96E0E2">
                        金额
                    </td>
                    <td bgcolor="#96E0E2">
                        备注
                    </td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-9">
                <tr>
                    <td>
                        金额总计
                    </td>
                    <td>
                        <input type="text" value="0" id="sum1" readonly="readonly">
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-9" style="border:solid 1px; background-color: #f0f0f0;text-align: center;">
                <span style="font-size:18px">通信费</span>
            </div>
            <table style="border-collapse:collapse;" border="0" cellpadding="2" cellspacing="1" class="col-xs-9" id="table6">
                <tr>
                    <td>
                        金额
                    </td>
                    <td>
                        <input type="text" value="0" id="sum6" onblur="addMoney('table6')">
                    </td>
                    <td>
                        备注(话费实际发生月份)
                    </td>
                    <td>
                        <input type="text" id="remark">
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-9" style="border:solid 1px; background-color: #f0f0f0;text-align: center;">
                <span style="font-size:18px">餐费明细(每人每餐报销不超过50元)</span>
            </div>
            <table style="border-collapse:collapse;" border="0" cellpadding="2" cellspacing="1" class="col-xs-9" id="table2">
                <tr>
                    <td bgcolor="#96E0E2">
                        日期
                    </td>
                    <td bgcolor="#96E0E2">
                        就餐地点
                    </td>
                    <td bgcolor="#96E0E2">
                        同行人(姓名)
                    </td>
                    <td bgcolor="#96E0E2">
                        就餐人数
                    </td>
                    <td bgcolor="#96E0E2">
                        实报金额
                    </td>
                    <td bgcolor="#96E0E2">
                        人均餐费
                    </td>
                    <td bgcolor="#96E0E2">
                        发票金额
                    </td>
                    <td bgcolor="#96E0E2">
                        工时
                    </td>
                    <td bgcolor="#96E0E2">
                        备注
                    </td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-9">
                <tr>
                    <td>
                        金额总计
                    </td>
                    <td>
                        <input type="text" value="0" id="sum2" readonly="readonly">
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-9" style="border:solid 1px; background-color: #f0f0f0;text-align: center;">
                <span style="font-size:18px">招待费明细</span>
            </div>
            <table style="border-collapse:collapse;" border="0" cellpadding="2" cellspacing="1" class="col-xs-9" id="table3">
                <tr>
                    <td bgcolor="#96E0E2">
                        日期
                    </td>
                    <td bgcolor="#96E0E2">
                        地点
                    </td>
                    <td bgcolor="#96E0E2">
                        业务目的
                    </td>
                    <td bgcolor="#96E0E2">
                        客户单位
                    </td>
                    <td bgcolor="#96E0E2">
                        客户姓名
                    </td>
                    <td bgcolor="#96E0E2">
                        参加人数
                    </td>
                    <td bgcolor="#96E0E2">
                        金额
                    </td>
                    <td bgcolor="#96E0E2">
                        备注
                    </td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-9">
                <tr>
                    <td>
                        金额总计
                    </td>
                    <td>
                        <input type="text" value="0" id="sum3" readonly="readonly">
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-9" style="border:solid 1px; background-color: #f0f0f0;text-align: center;">
                <span style="font-size:18px">员工关系费明细</span>
            </div>
            <table style="border-collapse:collapse;" border="0" cellpadding="2" cellspacing="1" class="col-xs-9" id="table4">
                <tr>
                    <td bgcolor="#96E0E2">
                        日期
                    </td>
                    <td bgcolor="#96E0E2">
                        地点
                    </td>
                    <td bgcolor="#96E0E2">
                        同行人(姓名)
                    </td>
                    <td bgcolor="#96E0E2">
                        活动目的
                    </td>
                    <td bgcolor="#96E0E2">
                        金额
                    </td>
                    <td bgcolor="#96E0E2">
                        备注
                    </td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-9">
                <tr>
                    <td>
                        金额总计
                    </td>
                    <td>
                        <input type="text" value="0" id="sum4" readonly="readonly">
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-9" style="border:solid 1px; background-color: #f0f0f0;text-align: center;">
                <span style="font-size:18px">其他费用</span>
            </div>
            <table style="border-collapse:collapse;" border="0" cellpadding="2" cellspacing="1" class="col-xs-9" id="table5">
                <tr>
                    <td bgcolor="#96E0E2">
                        费用项目
                    </td>
                    <td bgcolor="#96E0E2">
                        金额
                    </td>
                    <td bgcolor="#96E0E2">
                        备注
                    </td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-9">
                <tr>
                    <td>
                        金额总计
                    </td>
                    <td>
                        <input type="text" value="0" id="sum5" readonly="readonly">
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-9" style="border:solid 1px; background-color: #f0f0f0;text-align: center;">
                <span style="font-size:18px">审批记录</span>
            </div>
            <table style="border-collapse:collapse;" border="1" cellpadding="2" cellspacing="1" class="col-xs-9">
                <tr>
                    <td>
                        本部门主管意见<input type="text" style="width: 50%">
                    </td>
                    <td>
                        部门总监意见<input type="text" style="width: 50%">
                    </td>
                </tr>
                <tr>
                    <td>
                        部门VP意见<input type="text" style="width: 50%">
                    </td>
                    <td>
                        财务总监意见<input type="text" style="width: 50%">
                    </td>
                </tr>
                <tr>
                    <td>
                        CFO意见<input type="text" style="width: 50%">
                    </td>
                    <td>
                        CEO意见<input type="text" style="width: 50%">
                    </td>
                </tr>
                <tr>
                    <td>
                        报销审核组<input type="text" style="width: 50%">
                    </td>
                    <td>
                        出纳<input type="text" style="width: 50%">
                    </td>
                </tr>
            </table>
        </div>
    </div>
</div>
<script src="static/js/utils.js">
</script>
<script src="static/js/dialog_common.js">
</script>
<script src="static/ace/js/jquery.dataTables.min.js">
</script>
<script src="static/ace/js/jquery.dataTables.bootstrap.js">
</script>
<script language=JavaScript>
    
    jQuery(function($){
        window.edit_form = $("#edit-form").html();
        showInfo("oa/applyinfo");
        
    });
    //显示表格数据
    function showInfo(url){
        var ex = document.getElementById("apply_table");
        if ($.fn.dataTable.fnIsDataTable(ex)) {
            $(ex).dataTable().fnDestroy();
        }
        var aoColumns = [{
            "sTitle": "员工编号",
            "sWidth": 200,
            "sClass": "center"
        }, {
            "sTitle": "部门",
            "sWidth": 200,
            "sClass": "center"
        }, {
            "sTitle": "姓名",
            "sWidth": 200,
            "sClass": "center"
        }, {
            "sTitle": "申请日期",
            "sWidth": 200,
            "sClass": "center"
        }, {
            "sTitle": "报销金额",
            "sWidth": 200,
            "sClass": "center"
        }, {
            "sTitle": "报销详情",
            "sWidth": 200,
            "sClass": "center"
        }];
        var wh = $(window).height();
        var sY = (wh - 100) + 'px';
        var oTable = $(ex).dataTable({
            "bFilter": false,
            "bAutoWidth": true,
            "bProcessing": false,
            "bServerSide": true,
            "sDom": 't<"row"<"col-sm-12"i>>',
            "bSort": false,
            "bScrollCollapse": true,
            "iDisplayLength": 20,
            "iDisplayStart": 0,
            "aoColumns": aoColumns,
            "sAjaxSource": "",
            "bScrollInfinite": true,
            "sScrollY": sY,
            "fnServerData": function(sSource, aDataSet, fnCallback){
                $.ajax({
                    "dataType": 'json',
                    "type": "POST",
                    "url": url,
                    "data": aDataSet,
                    "success": function(resp){
                        console.log(resp);
                        var data = resp.data;
                        var iTotalRecords = data.count || 0;
                        var iTotalDisplayRecords = iTotalRecords;
                        var aaData = showApplyInfo(data);
                        console.log(aaData);
                        var data = {
                            "aaData": aaData,
                            "iTotalRecords": (iTotalRecords || 0),
                            "iTotalDisplayRecords": (iTotalDisplayRecords || 0)
                        };
                        fnCallback(data);
                    },
                    error: function(){
                        showCommonNoticeDialog('网络错误', 'icon-bolt', generateNoticeMsg('网络错误，请刷新后重试!'), 300);
                    }
                });
            },
            "fnDrawCallback": function(){
                if (!oTable) {
                    return;
                }
                oTable.$('tr.row_selected').removeClass('row_selected');
                oTable.$("tr").unbind('click');
                oTable.$("tr").click({
                    oTable: oTable
                }, function(e){
                    if ($(this).hasClass('row_selected')) {
                        $(this).removeClass('row_selected');
                    }
                    else {
                        e.data.oTable.$('tr.row_selected').removeClass('row_selected');
                        $(this).addClass('row_selected');
                    }
                });
            }
        })
    }
    
    //显示编辑对话框
    function showEditDialog(formInfo){
        $('#edit-form').html(edit_form);
        
        $('#edit_content').append($('#inner').show());
        $("#dialog-confirm").removeClass('hide').dialog({
            width: 1500,
            height: 1200,
            modal: true,
            draggable: true,
            resizable: false,
            title: "报销页详情",
            close: function(){
                $(this).dialog('destroy');
                $('#edit-form').empty();
            }
        });
    }
    
	function tableInfo(forminfo){
		var table = document.getElementById("table");
        table.rows[0].cells[1].childNodes[0].value = forminfo.rtxId;
		table.rows[0].cells[3].childNodes[0].value = forminfo.serialNumber;
		table.rows[0].cells[5].childNodes[0].value = forminfo.applyDate;
	}
	
    function showApplyInfo(data){
        var aaData = [];
        var needData = data.aaData;
        var formInfos = data.formInfos;
        var d_len = needData.length;
        for (var i = 0; i < d_len; i++) {
            var money = parseFloat(needData[i][4]);
            money /= 100;
            console.log(formInfos[i]);
            var map = '<a href="javascript:void(0);" onclick="showEditDialog(\'' + formInfos[i] + '\')"><i class="icon-link"></i></a>';
            aaData.push([needData[i][0], needData[i][1], needData[i][2], needData[i][3], money.toFixed(2), map]);
        }
        return aaData;
    }
    
    $.extend(true, $.fn.dataTable.defaults, {
        "sPaginationType": "bootstrap",
        "oLanguage": {
            "sEmptyTable": "无数据",
            "sProcessing": "正在获取数据，请稍后...",
            "oPaginate.sFirst": "第一页",
            "oPaginate.sLast": "最后一页",
            "oPaginate.sNext": "下一页",
            "oPaginate.sPrevious": "上一页",
            "sInfo": "本页 _START_ - _END_ , 共 _TOTAL_ 条记录",
            "sInfoEmpty": "本页 0 - 0 , 共 0 条记录",
            "sSearch": "搜索: ",
            "sLengthMenu": "共_MENU_记录"
        }
    });
</script>
