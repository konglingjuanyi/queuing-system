#set($layout = "layout/oa_layout.vm")
<style type="text/css">
    td input {
        width: 100%;
        text-align: center;
        color: red;
        font-size: larger;
    }

    td {
        text-align: center;
    }


</style>
<div class="row">
    <div class="col-xs-12">
        <div class="col-xs-5">
            <div class="form-group dash-button-group" style="margin-bottom: 0px; float: left;">
                <button id="approve_pass"
                        style="width: 60px; height:28px; font-size: 14px; margin: 0px 2px 4px; font-weight: bold"
                        class="btn btn-minier btn-primary">
                    同意
                </button>
                <button id="approve_reject"
                        style="width: 60px; height:28px; font-size: 14px; margin: 0px 2px 4px; font-weight: bold"
                        class="btn btn-minier btn-primary">
                    拒绝
                </button>
                <button id="approve_other"
                        style="width: 60px; height:28px; font-size: 14px; margin: 0px 2px 4px; font-weight: bold"
                        class="btn btn-minier btn-primary">
                    加签
                </button>
            </div>
        </div>
        <form action="oa/approve_todo_export" method="post">
        <div class="col-xs-7">
            <div class="form-group dash-button-group" style="margin-bottom: 0px; float: right;">
        <span class="input-icon input-icon-right">
            <input class="date" id="date-from" type="text" style="width: 100px" onclick="showTime()"
                   placeholder="申请日期..."/>
                   <i class="icon-calendar green"></i>
        </span>
        <span class="input-icon input-icon-right">
            <input class="date" id="date-to" type="text" style="width: 100px" onclick="showTime()"
                   placeholder="申请日期..."/>
                   <i class="icon-calendar green"></i>
        </span>
        <span class="input-icon input-icon-right">
            <input id="approve-user" name="approve-user" type="text" placeholder="申请人..." style="width: 100px"/>
        </span>
                <input type="button" id="search" value="查询"
                        style="width: 60px; height:28px; font-size: 14px; margin: 0px 2px 4px; font-weight: bold"
                        class="btn btn-minier btn-primary">
                <input type="submit" id="export"
                        style="width: 60px; height:28px; font-size: 14px; margin: 0px 2px 4px; font-weight: bold"
                        class="btn btn-minier btn-primary" value="导出">
                <input type="button" id="import" value="批量查询"
                        style="width: 80px; height:28px; font-size: 14px; margin: 0px 2px 4px; font-weight: bold"
                        class="btn btn-minier btn-primary">
            </div>
        </div>
        </form>
    </div>
    <div class="col-xs-12">
        <div class="col-xs-9">
            <div class="widget-box">
                <div class="widget-header header-color-blue" style="">
                    <h5 class="bigger lighter"><i class="icon-time"></i>当前审批</h5>
                </div>
                <div class="widget-body">
                    <table id="approve_todo"
                           class="table table-striped table-bordered table-hover"></table>
                </div>
            </div>

        </div>
        <div class="col-xs-3">
            <div class="widget-box">
                <div class="widget-header header-color-blue">
                    <h5 class="bigger lighter"><i class="icon-bar-chart"></i>详细信息</h5>
                </div>
                <div class="widget-body">
                    <div id="todo-approve-details-list" class="widget-main"></div>
                </div>
            </div>
        </div>
    </div>
</div>


<div id="dialog-confirm" class="hide">
    <form class="form-horizontal">
        <div id="edit-form">
            <div id="edit_content" align="center">
            </div>
        </div>
    </form>
</div>

<div id="approve-result-dialog" class="hide"></div>
<div id="reject-msg-dialog" class="hide"></div>
<div id="approve-msg-dialog" class="hide"></div>
<div id="back-msg-dialog" class="hide"></div>
<div id="endorse-msg-dialog" class="hide"></div>

<div id="common-notice-dialog" class="hide"></div>

<script src="static/js/utils.js">
</script>
<script src="static/js/dialog_common.js">
</script>
<script src="static/js/all_common.js">
</script>
<script src="static/js/approve_common.js">
</script>
<script src="static/ace/js/jquery.dataTables.min.js">
</script>
<script src="static/ace/js/jquery.dataTables.bootstrap.js">
</script>
<script src="/oaengine/static/My97DatePicker/WdatePicker.js"></script>
<script language=JavaScript>

    jQuery(function ($) {
        window.edit_form = $("#edit-form").html();
        showApproveTableInfo("oa/approve_todo", null);
    });

    function showApproveTableInfo(url, fids) {
        var ex = document.getElementById("approve_todo");
        if ($.fn.dataTable.fnIsDataTable(ex)) {
            $(ex).dataTable().fnDestroy();
        }
        var aoColumns = [
            {
                "sTitle": '<lable><input id="current-checkbox-select-all" ' +
                'type="checkbox" value="ALL" class="ace"><span class="lbl"></span></label>',
                "bSortable": false, "sClass": "center"
            },
            {"sTitle": 'ID', "sClass": "center", "sWidth": 100},
            {"sTitle": '金额', "sClass": "center", "sWidth": 150},
            {"sTitle": '发起人', "sClass": "center", "sWidth": 200},
            {"sTitle": '发起时间', "sClass": "center", "sWidth": 200},
            {"sTitle": '接收时间', "sClass": "center", "sWidth": 200},
            {"sTitle": "报销详情", "sClass": "center", "sWidth": 150}];

        var wh = $(window).height();
        var sY = (wh - 100) + 'px';
        var oTable = $(ex).dataTable({
            "bFilter": false,
            "bAutoWidth": true,
            "bProcessing": false,
            "bServerSide": true,
            "sDom": 't<"row"<"col-sm-12"i>>',
            "bSort": false,
            "bScrollCollapse": true,
            "iDisplayLength": 20,
            "iDisplayStart": 0,
            "aoColumns": aoColumns,
            "sAjaxSource": "",
            "bScrollInfinite": true,
            "sScrollY": sY,
            "fnServerData": function (sSource, aDataSet, fnCallback) {
                var startDate = $.trim($('#date-from').val());
                var endDate = $.trim($('#date-to').val());
                var approveUser = $.trim($('#approve-user').val());
                var start = 0;
                var length = 0;
                for (var i = 0; i < aDataSet.length; i++) {
                    if (aDataSet[i].name == 'iDisplayStart') {
                        start = aDataSet[i].value;
                    }
                    if (aDataSet[i].name == 'iDisplayLength') {
                        length = aDataSet[i].value;
                    }
                }
                var vars = {};
                vars["start"] = start;
                vars["length"] = length;
                if(fids != null){
                	vars["fids"] = fids;
                }
                if (startDate != '') {
                    vars["startTime"] = startDate;
                }
                if (endDate != '') {
                    vars["endTime"] = endDate;
                }

                if (approveUser != '') {
                    vars["approveUser"] = approveUser;
                }
                var params = {};
                params["vars"] = vars;
                $.ajax({
                    "contentType": "application/json; charset=utf-8",
                    "type": "POST",
                    "url": url,
                    "data": JSON.stringify(params),
                    "success": function (resp) {
                        if (resp.errorCode == 0) {
                            var data = resp.data;
                            var iTotalRecords = data.count || 0;
                            var iTotalDisplayRecords = iTotalRecords;
                            var aaData = showTableInfo(data, aoColumns.length);
                            data = {
                                "aaData": aaData,
                                "iTotalRecords": (iTotalRecords || 0),
                                "iTotalDisplayRecords": (iTotalDisplayRecords || 0)
                            };
                            fnCallback(data);
                        }
                        else {
                            showCommonNoticeDialog('失败', 'icon-warning-sign',
                                    generateNoticeMsg(resp.errorMessage), 300);
                        }
                    },
                    error: function () {
                        showCommonNoticeDialog('网络错误', 'icon-bolt', generateNoticeMsg('网络错误，请刷新后重试!'), 300);
                    }
                });
            },
            "fnDrawCallback": function () {
                if (!oTable) {
                    return;
                }

                $("#search").unbind("click");
                $("#search").on("click", function (e) {
                    showApproveTableInfo(url, null);
                }).on("dblclick", function (e) {
                    e.preventDefault();
                });
                $("#approve_pass").unbind("click");
                $("#approve_pass").on("click", function (e) {
                    approvePass(oTable);
                }).on("dblclick", function (e) {
                    e.preventDefault();
                });
                $("#import").unbind("click");
                $("#import").on("click", function (e) {
                	showUploadDialog();
                }).on("dblclick", function (e) {
                    e.preventDefault();
                });
                $("#approve_reject").unbind("click");
                $("#approve_reject").on("click", function (e) {
                    approveReject(oTable);
                }).on("dblclick", function (e) {
                    e.preventDefault();
                });

                $("#approve_back").unbind("click");
                $("#approve_back").on("click", function (e) {
                    approveBack(oTable);
                }).on("dblclick", function (e) {
                    e.preventDefault();
                });

                $("#approve_other").unbind("click");
                $("#approve_other").on("click", function (e) {
                    approveEndorse(oTable);
                }).on("dblclick", function (e) {
                    e.preventDefault();
                });
                oTable.$('tr.row_selected').removeClass('row_selected');
                oTable.$("tr").unbind('click');
                oTable.$("tr").click({
                    oTable: oTable
                }, function (e) {
                    if ($(this).hasClass('row_selected')) {
                        $(this).removeClass('row_selected');
                    }
                    else {
                        e.data.oTable.$('tr.row_selected').removeClass('row_selected');
                        $(this).addClass('row_selected');
                        var id = e.data.oTable.fnGetData(this)[1];
                        showApproveTodoDetailsList(id);
                    }
                });
            },
            fnInitComplete: function () {
                $('#current-checkbox-select-all').prop('checked', false);
                $('#current-checkbox-select-all').attr('checked', false);
                toggleCheck(oTable);
            }
        })
    }

    function approvePass(oTable) {
    	if($("input:checked", oTable.fnGetNodes()).size()==0){
    		showApproveResultDialog('审批', 'icon-lightbulb',
                    generateNoticeMsg('请选择要审批的条目!'), 300);
            return;
    	}
        var url = "oa/approve_pass";
        var dialog_width = Math.min(Math.round(window.screen.width * 0.7), 900);
        try {
            $("#approve-msg-dialog").empty();
            var form = createOperateMsgForm('Tips: 同意理由请不要超过100个字符');
            $("#approve-msg-dialog").append(form);
            var dialog = $("#approve-msg-dialog").removeClass('hide').dialog({
                modal: true,
                width: dialog_width,
                height: 250,
                title: '<div style="color: DodgerBlue; padding: 4px; height: 28px; font-size: 14px; font-weight: bold">' +
                '<li class="icon-user"></li> 同意理由</div>',
                title_html: true,
                closeOnEscape: false,
                open: function (event, ui) {
                    $(".ui-dialog-titlebar-close").hide();
                },
                buttons: [
                    {
                        id: "approve-msg-submit",
                        text: "提交",
                        "class": "btn btn-primary btn-xs",
                        click: function (e) {
                            enableCurrentApproveToolbarButton(false);
                            try {
                                var this_form = $("#approve-msg-dialog").find("form");
                                var postData = this_form.serializeArray();
                                var msg = "";
                                for (var i in postData) {
                                    if (postData[i]['name'] == 'msg') {
                                        if (postData[i]['value'].length >= 100) {
                                            enableAccountApplicationDialogButton(true);
                                            showCommonNoticeDialog('同意理由错误', 'icon-warning-sign',
                                                    generateNoticeMsg('同意理由不能超过100个字符'), 300);
                                            return;
                                        } else {
                                            msg = postData[i]['value'];
                                            break;
                                        }
                                    }
                                }
                                approveProxy(oTable, url, msg, "审批通过");
                                e.preventDefault(); //STOP default action
                                $(this).dialog("close");
                            } catch (e) {
                                enableAccountApplicationDialogButton(true);
                                showCommonNoticeDialog('网络错误', 'icon-warning-sign',
                                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
                            }
                        }
                    },
                    {
                        id: "approve-msg-cancel",
                        text: "取消",
                        "class": "btn btn-xs",
                        click: function () {
                            $(this).dialog("close");
                        }
                    }
                ]
            });
        } catch (e) {
            showCommonNoticeDialog('网络错误', 'icon-warning-sign',
                    generateNoticeMsg('网络错误，请刷新后重试!'), 300);
        }

    }

    function approveReject(oTable) {
    	if($("input:checked", oTable.fnGetNodes()).size()==0){
    		showApproveResultDialog('审批', 'icon-lightbulb',
                    generateNoticeMsg('请选择要审批的条目!'), 300);
            return;
    	}
        var url = "oa/approve_reject";
        var dialog_width = Math.min(Math.round(window.screen.width * 0.7), 900);
        try {
            $("#reject-msg-dialog").empty();
            $("#reject-msg-dialog").append(createOperateMsgForm('Tips: 拒绝理由请不要超过100个字符'));
            var dialog = $("#reject-msg-dialog").removeClass('hide').dialog({
                modal: true,
                width: dialog_width,
                height: 250,
                title: '<div style="color: DodgerBlue; padding: 4px; height: 28px; font-size: 14px; font-weight: bold"><li class="icon-user"></li> 拒绝理由</div>',
                title_html: true,
                closeOnEscape: false,
                open: function (event, ui) {
                    $(".ui-dialog-titlebar-close").hide();
                },
                buttons: [
                    {
                        id: "reject-msg-submit",
                        text: "提交",
                        "class": "btn btn-primary btn-xs",
                        click: function (e) {
                            var Me = this;
                            enableCurrentApproveToolbarButton(false);
                            try {
                                var this_form = $("#reject-msg-dialog").find("form");

                                var postData = this_form.serializeArray();
                                var msg = "";
                                for (var i in postData) {
                                    if (postData[i]['name'] == 'msg') {
                                        if (postData[i]['value'].length >= 100) {
                                            enableAccountApplicationDialogButton(true);
                                            showCommonNoticeDialog('拒绝理由错误', 'icon-warning-sign',
                                                    generateNoticeMsg('拒绝理由不能超过100个字符'), 300);
                                            return;
                                        } else if (postData[i]['value'].length == 0) {
                                            showCommonNoticeDialog('拒绝理由错误', 'icon-warning-sign',
                                                    generateNoticeMsg('拒绝理由不能为空'), 300);
                                            return;
                                        } else {
                                            msg = postData[i]['value'];
                                            break;
                                        }
                                    }
                                }
                                approveProxy(oTable, url, msg, "拒绝");
                                e.preventDefault(); //STOP default action
                                $(this).dialog("close");
                            } catch (e) {
                                enableAccountApplicationDialogButton(true);
                                showCommonNoticeDialog('网络错误', 'icon-warning-sign',
                                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
                            }
                        }
                    },
                    {
                        id: "reject-msg-cancel",
                        text: "取消",
                        "class": "btn btn-xs",
                        click: function () {
                            $(this).dialog("close");
                        }
                    }
                ]
            });
        } catch (e) {
            showCommonNoticeDialog('网络错误', 'icon-warning-sign',
                    generateNoticeMsg('网络错误，请刷新后重试!'), 300);
        }
    }

    function approveEndorse(oTable) {
    	if($("input:checked", oTable.fnGetNodes()).size()==0){
    		showApproveResultDialog('审批', 'icon-lightbulb',
                    generateNoticeMsg('请选择要审批的条目!'), 300);
            return;
    	}
        var url = "oa/approve_endorse";
        var dialog_width = Math.min(Math.round(window.screen.width * 0.7), 900);
        try {
            $("#endorse-msg-dialog").empty();
            $("#endorse-msg-dialog").append(createEndorseMsgForm('Tips: 请输入加签RTX_ID'));
            var dialog = $("#endorse-msg-dialog").removeClass('hide').dialog({
                modal: true,
                width: dialog_width,
                height: 300,
                title: '<div style="color: DodgerBlue; padding: 4px; height: 28px; font-size: 14px; font-weight: bold"><li class="icon-user"></li> 加签理由</div>',
                title_html: true,
                closeOnEscape: false,
                open: function (event, ui) {
                    $(".ui-dialog-titlebar-close").hide();
                },
                buttons: [
                    {
                        id: "endorse-msg-submit",
                        text: "提交",
                        "class": "btn btn-primary btn-xs",
                        click: function (e) {
                            var Me = this;
                            enableCurrentApproveToolbarButton(false);
                            try {
                                var this_form = $("#endorse-msg-dialog").find("form");

                                var postData = this_form.serializeArray();
                                var msg = "";
                                if( $("#rtx_id").val() == ''){
                                	showCommonNoticeDialog('加签错误', 'icon-warning-sign',
                                                    generateNoticeMsg('加签对象不能为空'), 300);
                                    return;
                                }
                                for (var i in postData) {
                                    if (postData[i]['name'] == 'msg') {
                                        if (postData[i]['value'].length >= 100) {
                                            enableAccountApplicationDialogButton(true);
                                            showCommonNoticeDialog('加签错误', 'icon-warning-sign',
                                                    generateNoticeMsg('加签理由不能超过100个字符'), 300);
                                            return;
                                        } else if (postData[i]['value'].length == 0) {
                                            showCommonNoticeDialog('加签错误', 'icon-warning-sign',
                                                    generateNoticeMsg('加签理由不能为空'), 300);
                                            return;
                                        } else {
                                            msg = postData[i]['value'];
                                            break;
                                        }
                                    }
                                }
                                approveProxy(oTable, url, msg, "加签", $("#rtx_id").val());
                                e.preventDefault(); //STOP default action
                                $(this).dialog("close");
                            } catch (e) {
                                enableAccountApplicationDialogButton(true);
                                showCommonNoticeDialog('网络错误', 'icon-warning-sign',
                                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
                            }
                        }
                    },
                    {
                        id: "endorse-msg-cancel",
                        text: "取消",
                        "class": "btn btn-xs",
                        click: function () {
                            $(this).dialog("close");
                        }
                    }
                ]
            });
        } catch (e) {
            showCommonNoticeDialog('网络错误', 'icon-warning-sign',
                    generateNoticeMsg('网络错误，请刷新后重试!'), 300);
        }
    }

    function approveProxy(oTable, url, msg, action, rtx_id) {
//            enableCurrentApproveToolbarButton(false);
        var formIds = new Array();
        var taskIds = new Array();
        console.log(oTable.fnGetNodes());
        $("input:checked", oTable.fnGetNodes()).each(function () {
            var row = $(this).parent().parent().parent();
            var nTds = $('td', row);
            var formId = nTds[1].childNodes[0].data;
            var taskId = $(this).val();//nTds[7].childNodes[0].data;
            console.log(taskId);
            formIds += formId + ",";
            taskIds += taskId + ",";
        });
        if (formIds.length < 1) {
//                $("#approve-page").unmask();
            enableCurrentApproveToolbarButton(true);
            showApproveResultDialog('审批', 'icon-lightbulb',
                    generateNoticeMsg('请选择要审批的条目!'), 300);
            return;
        }
        var params = {};
        var vars = {};
        vars["formIds"] = formIds;
        vars["taskIds"] = taskIds;
        vars["memo"] = msg;
        vars["rtx_id"] = rtx_id;
        params["vars"] = vars;
        $.ajax({
            contentType: "application/json; charset=utf-8",
            url: url,
            type: "post",
            data: JSON.stringify(params),
            success: function (resp) {
                var title_html_str = '';
                try {
                    if (resp.errorCode == 0) {
                        title_html_str = '<div class="dialog_title"><li class="icon-info-sign"></li> 审批' + action + '</div>';
                        var succeed_html = '<b><li class="icon-check"></li> ' + action + '成功</b><br/>';
                        $("#approve-result-dialog").append(generateNoticeMsg(succeed_html));
                    } else {
                        title_html_str = '<div class="dialog_title"><li class="icon-exclamation-sign"></li>审批' + action + '</div>';
                        $("#approve-result-dialog").append(generateNoticeMsg(resp.errorMessage));
                    }
                } catch (e) {
                }
                var dialog = $("#approve-result-dialog").removeClass('hide').dialog({
                    modal: true,
                    width: 400,
                    resizable: true,
                    title: title_html_str,
                    title_html: true,
                    closeOnEscape: false,
                    buttons: [
                        {
                            text: "确定",
                            "class": "btn btn-primary btn-xs",
                            click: function () {
                                enableCurrentApproveToolbarButton(true);
                                $("#approve-result-dialog").empty();
                                $("#approve-result-dialog").dialog('destroy');
                            }
                        }
                    ],
                    close: function () {
                        enableCurrentApproveToolbarButton(true);
                        $("#approve-result-dialog").empty();
                        $("#approve-result-dialog").dialog('destroy');
                    }
                });
                showApproveTableInfo("oa/approve_todo", null);
            },
            "error": function (jqxhr, textstatus, errorthrown) {
                enableCurrentApproveToolbarButton(true);
                showApproveResultDialog('网络错误', 'icon-warning-sign',
                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
            }
        });
    }

    function enableCurrentApproveToolbarButton(enable) {
        /*if (enable) {
            $("#approve_pass").removeAttr('disabled');
            $("#approve_reject").removeAttr('disabled');
        } else {
            $("#approve_pass").attr('disabled', 'true');
            $("#approve_reject").attr('disabled', 'true');
        }*/
    }

    function showApproveResultDialog(header, header_icon, msg, width) {
        $("#approve-result-dialog").append(msg);
        var title_html_str = $.parseStr('<div class="dialog_title"><li class="%s"></li> %s</div>', header_icon, header);
        var edit_dialog = $("#approve-result-dialog").removeClass('hide').dialog({
            modal: true,
            width: width,
            resizable: true,
            title: title_html_str,
            title_html: true,
            closeOnEscape: false,
            open: function (event, ui) {
                $(".ui-dialog-titlebar-close").hide();
            },
            buttons: [
                {
                    text: "确定",
                    "class": "btn btn-primary btn-xs",
                    click: function () {
                        $("#approve-result-dialog").empty();
                        $("#approve-result-dialog").dialog('destroy')
                    }
                }
            ],
            close: function () {
                $("#approve-result-dialog").empty();
                $("#approve-result-dialog").dialog('destroy')
            }
        });
    }

    function createOperateMsgForm(msg) {
        var tips = msg;
        var form = '<form style="width: 100%; background-color: white"> ';
        form += '<div>';
        form += $.parseStr('<textarea class="form-control" name="msg" style="height: 100px;" placeholder="%s"></textarea>', tips);
        form += '</div>';
        form += '</form>';
        return form;
    }

    //  加签需要填写rtx_id
    function createEndorseMsgForm(msg) {
        var tips = msg;
        var form = '<form style="width: 100%; background-color: white"> ';

        form += '<div class="form-group">';
        form += '<label>加签给：</label>';
        form += $.parseStr('<input class="form-control" id="rtx_id" placeholder="%s">', "请输入rtx_id, 不能为空");
        form += '</div>';
        form += '<div class="space-4"></div>';
        form += '<div>';
        form += $.parseStr('<textarea class="form-control" name="msg" style="height: 100px;" placeholder="%s"></textarea>', tips);
        form += '</div>';
        form += '</form>';
        return form;
    }


    function enableAccountApplicationDialogButton(enable) {
        /*if (enable) {
            $("#account-application-submit").removeAttr('disabled');
            $("#account-application-cancel").removeAttr('disabled');
        } else {
            $("#account-application-submit").attr('disabled', 'true');
            $("#account-application-cancel").attr('disabled', 'true');
        }*/
    }

    function showTableInfo(data, len) {
        var aaData = [];
        var needData = data.tableInfos;
        var d_len = needData.length;
        for (var i = 0; i < d_len; i++) {
            var checkbox = '<label><input value="'+needData[i][5]+'" type="checkbox" class="ace"> <span class="lbl"></span></label>';
            var money = parseFloat(needData[i][4]);
            money /= 100;
            var map = "";
            if(needData[i][7] == 'true'){
            	map = $.parseStr("<a href='javascript:void(0);' " +
            	"onclick='update(%s, %s, \"%s\");'><i class='icon-link'></i></a>", needData[i][0], needData[i][5], needData[i][8]);
            	checkbox = '<label><input value="'+needData[i][5]+'" type="checkbox" class="ace" disabled> <span class="lbl"></span></label>';
            }else if(needData[i][6] == 'false'){
            	map = $.parseStr("<a href='javascript:void(0);' " +
            	"onclick='showEditDialog(%s, %s);'><i class='icon-link'></i></a>", needData[i][0]);
            }else if(needData[i][6] == 'true' && needData[i][9] == 'fin_check'){
            	map = $.parseStr("<a href='javascript:void(0);' " +
            	"onclick='edit(%s, %s);'><i class='icon-link'></i></a>", needData[i][0], needData[i][5]);
            	checkbox = '<label><input value="'+needData[i][5]+'" type="checkbox" class="ace" disabled> <span class="lbl"></span></label>';
            }
            var need_list = [checkbox, needData[i][0], money.toFixed(2), needData[i][1], needData[i][3], needData[i][10], map];
            var d_list = [];
            for(j = 0; j < len; j++){
                d_list.push(need_list[j]);
            }
            aaData.push(d_list);
        }
        return aaData;
    }
    
    function edit(formId, taskId) {
        window.location.href = "oa/apply_ratify.html?formId=" + formId + "&taskId=" + taskId;
    }
    
    function update(formId, taskId, eu) {
        window.location.href = "oa/apply.html?formId=" + formId + "&taskId=" + taskId + "&euid=" + eu;
    }

    function showTime() {
        WdatePicker({dateFmt: 'yyyy-MM-dd'});
    }

    function showApproveTodoDetailsList(id) {
        if (id == undefined || id == '') {
            $("#todo-approve-details-list").html('');
            return;
        }
        var params = {
            "vars": {
                formId: id
            }
        };
        $.ajax({
            "contentType": "application/json; charset=utf-8",
            "url": "oa/approve_info",
            "type": "POST",
            "data": JSON.stringify(params),
            success: function (resp) {
                if (resp.errorCode == "0") {
                    if (resp.data.length != 0) {
                        try {
                            var details = resp.data;
                            var html = '';
                            html += __generateDetailHtml('当前审批状态', 'icon-eye-open', ["审批过程中"], true);
                            html += __generateDetailHtml('审批历史', 'icon-book', details, true);
                            $("#todo-approve-details-list").html(html);
                        } catch (e) {
                        }
                    } else {
                        $("#todo-approve-details-list").html('无详细信息');
                    }
                } else {
                    $("#todo-approve-details-list").html(resp.errorMessage);
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                showCommonNoticeDialog('网络错误', 'icon-warning-sign',
                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
            }
        })
    }
    

	function showUploadDialog() {
	    var form = '<div style="padding: 10px 0px">'
	        + '<form id="upload_configure_form">'
	        + '<input type="file" name="file"/>'
	        + '</form>'
	        + $.parseStr(
	            '<div id="upload_configure_msg" style="%s"></div>',
	            'width: 100%; line-height: 18px; font-size: 14px; font-weight: bold; padding: 15px 5px 5px 5px'
	        );
	    $("#approve-msg-dialog").html(form);
	    title_html_str = '<div class="dialog_title">批量导入机器</div>'
	    var dialog = $("#approve-msg-dialog").removeClass('hide').dialog({
	        modal: true,
	        width: 450,
	        resizable: false,
	        title: title_html_str,
	        title_html: true,
	        buttons: [
	            {
	                text: "确认上传",
	                "class": "btn btn-danger btn-xs",
	                click: function () {
	                    $("#upload_configure_msg").html('<div style="color: blue"><p>正在上传，请稍后......</p></div>');
	                    var formData = new FormData();
	                    formData.append('file', $('#upload_configure_form input[name=file]').get(0).files[0]);
	                    $.ajax({
	                        url: 'oa/parse_xls',
	                        contentType: false,
	                        data: formData,
	                        processData: false,
	                        type: 'POST',
	                        success: function (resp) {
	                            var data = resp || {};
	                            if (data.errorCode == 0) {
	                            	$("#approve-msg-dialog").dialog("close");
	                            	showApproveTableInfo("oa/approve_todo", data.data);
	                            }else{
	                            	var msg_dom = '<div style="color: red">'
	                                        + $.parseStr('<p>%s</p>', data.errorMessage || '')
	                                        + '</div>';
	                                    $("#upload_configure_msg").html(msg_dom);
	                            }
	                        },
	                        error: function () {
	                            $("#upload_configure_msg").html('<div style="color: red"><p>网络错误</p></div>');
	                        }
	                    });
	
	                }
	            },
	            {
	                text: "取消",
	                "class": "btn btn-xs",
	                click: function () {
	                    $("#approve-msg-dialog").dialog("close");
	                }
	            }
	        ],
	        close: function () {
	            $("#approve-msg-dialog").empty()
	            $("#approve-msg-dialog").dialog('destroy')
	        }
	    });
	
	}
</script>
