#set($layout = "layout/oa_layout.vm")
<style type="text/css">
    td input {
        width: 100%;
        text-align: center;
        color: red;
        font-size: larger;
    }

    td {
        text-align: center;
    }

</style>
<div id="common-notice-dialog" class="hide"></div>
<div class="col-xs-32">
    <!-- PAGE CONTENT BEGINS -->
    <div style="text-align: center" class="col-xs-32">
        <h3 class="header smaller lighter blue" style="margin-left: auto;margin-right: auto;">日常费用报销单</h3>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span
                    style="font-size:18px">个人基本信息</span></div>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12"
                   id="table">
                <tr>
                    <td>申请人</td>
                    <td><input type="text" readonly="readonly"></td>
                    <td>员工编号</td>
                    <td><input type="text" readonly="readonly"></td>
                    <td>申请日期</td>
                    <td><input type="text" style="color:red" readonly="readonly"></td>
                </tr>
                <tr>
                    <td>一级部门</td>
                    <td><input type="text" readonly="readonly"></td>
                    <td>申请部门</td>
                    <td><input type="text" readonly="readonly"></td>
                    <td>部门编号</td>
                    <td><input type="text" readonly="readonly"></td>
                </tr>
                <tr>
                    <td>是否直接向VP汇报</td>
                    <td><input name="Fruit" type="radio" checked="false" style="width:10% !important" value="是"/>是<input name="Fruit" type="radio" checked="true" style="width:10% !important" value="否"/>否</td>
                    <td>银行卡号</td>
                    <td><input type="text" readonly="readonly"></td>
                    <td>银行开户行</td>
                    <td><input type="text" readonly="readonly"></td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>报销金额总计</td>
                    <td><input type="text" value="0.00" id="sum" readonly="readonly"></td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>核定金额总计</td>
                    <td><input type="text" value="0.00" id="ratify" readonly="readonly"></td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>冲销借款总计</td>
                    <td><input type="text" value="0.00" id="borrowAmount" readonly="readonly"></td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>&nbsp;&nbsp;支付金额&nbsp;&nbsp;</td>
                    <td><input type="text" value="0.00" id="payAmount" readonly="readonly"></td>
                </tr>
            </table>         
        </div>

    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span style="font-size:18px">冲销借款</span></div>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12" id="table7">
                <tr>
                    <td bgcolor="#96E0E2">借款编号</td>
                    <td bgcolor="#96E0E2">借款日期</td>
                    <td bgcolor="#96E0E2">借款金额</td>
                    <td bgcolor="#96E0E2">借款余额</td>
                    <td bgcolor="#96E0E2">冲销金额</td>
                </tr>
                #foreach($loan in $loans)
                <tr>
                    <td><input type="hidden" value="$loan[0]">$loan[0]</td>
                    <td><input type="hidden" value="$loan[1]">$loan[1]</td>
                    <td><input type="hidden" value="$loan[2]">$loan[2]</td>
                    <td><input type="hidden" value="$loan[3]">$loan[3]</td>
                    <td><input id="loan_$loan[0]" type="text" value="" onblur="addBorrowAmount(this.value)"></td>
                </tr>
				#end
            </table>
        </div>
        <div class="col-sm-12">
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span
                    style="font-size:18px">出租车费明细(含汽车燃油费)</span></div>
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: left;">
            <span class="input-icon input-icon-right">
            <input class="date" id="auto-file-date-from-table1" type="text" style="width: 186px" onclick="showTime()" placeholder="开始日期..."/>
            <i class="icon-calendar green"></i>
        	</span>
            <span class="input-icon input-icon-right">
            <input class="date" id="auto-file-date-to-table1" type="text" style="width: 186px" onclick="showTime()" placeholder="结束日期..."/>
            <i class="icon-calendar green"></i>
        	</span>
            <button onclick="autoFill('table1')">自动填写</button>
            </div>
            <table frame="vsides" class="col-xs-12"
                   id="table1">
                <tr>
                    <td bgcolor="#96E0E2">日期</td>
                    <td bgcolor="#96E0E2">起点</td>
                    <td bgcolor="#96E0E2">终点</td>
                    <td bgcolor="#96E0E2">具体时间</td>
                    <td bgcolor="#96E0E2">用途</td>
                    <td bgcolor="#96E0E2">同行人(姓名)</td>
                    <td bgcolor="#96E0E2">工时</td>
                    <td bgcolor="#96E0E2">金额</td>
                    <td bgcolor="#96E0E2">核定金额</td>
                    <td bgcolor="#96E0E2">备注</td>
                    <td bgcolor="#96E0E2" width="0"></td>
                    <td bgcolor="#96E0E2" style="width:20px !important">
                        <input type="button" name="Submit" value="添加报销" onclick=addRow("table1")>
                    </td>
                </tr>
                <tr>
                    <td><span class="input-icon input-icon-right">
            <input type="text" onclick="showTimeAndLabor('table1', this)"/>
            <i class="icon-calendar green"></i>
        </span></td>
                    <td><input type="text"></td>
                    <td><input type="text"></td>
                    <td><input type="text"></td>
                    <td><input type="text"></td>
                    <td><input type="text"></td>
                    <td><input type="text" disabled="disabled" onblur="isNumber(this, '工时')"></td>
                    <td><input type="text" onblur="addMoney('table1')"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text"></td>
                    <td><input type='hidden' value=''></td>

                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>金额总计</td>
                    <td><input type="text" value="0.00" id="sum1" readonly="readonly"></td>
                </tr>
                <tr>
                    <td>核定金额总计</td>
                    <td><input type="text" value="0.00" id="ratify1" readonly="readonly"></td>
                </tr>
            </table>
        </div>

    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span
                    style="font-size:18px">通信费</span></div>
            <table frame="vsides" class="col-xs-12"
                   id="table6">
                <tr>
                    <td>金额</td>
                    <td><input type="text" value="0.00" id="sum6" onblur="addMoney('table6')"></td>
                    <td>核定金额</td>
                    <td><input type="text" value="0.00" id="ratify6" disabled="disabled"></td>
                    <td>备注(话费实际发生月份)</td>
                    <td><input type="text" id="remark"></td>
                </tr>
            </table>
        </div>

    </div>

    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span
                    style="font-size:18px">餐费明细(每人每餐报销不超过50元)</span></div>
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: left;">
            <span class="input-icon input-icon-right">
            <input class="date" id="auto-file-date-from-table2" type="text" style="width: 186px" onclick="showTime()" placeholder="开始日期..."/>
            <i class="icon-calendar green"></i>
        	</span>
            <span class="input-icon input-icon-right">
            <input class="date" id="auto-file-date-to-table2" type="text" style="width: 186px" onclick="showTime()" placeholder="结束日期..."/>
            <i class="icon-calendar green"></i>
        	</span>
            <button onclick="autoFill('table2')">自动填写</button>
            </div>
            <table frame="vsides" class="col-xs-12"
                   id="table2">
                <tr>
                    <td bgcolor="#96E0E2">日期</td>
                    <td bgcolor="#96E0E2">就餐地点</td>
                    <td bgcolor="#96E0E2">同行人(姓名)</td>
                    <td bgcolor="#96E0E2">就餐人数</td>
                    <td bgcolor="#96E0E2">实报金额</td>
                    <td bgcolor="#96E0E2">人均餐费</td>
                    <td bgcolor="#96E0E2">发票金额</td>
                    <td bgcolor="#96E0E2">工时</td>
                    <td bgcolor="#96E0E2">核定金额</td>
                    <td bgcolor="#96E0E2">备注</td>
                    <td bgcolor="#96E0E2" width="0"></td>
                    <td bgcolor="#96E0E2"><input type="button" name="Submit" value="添加报销"
                                                 onclick=addRow("table2")></td>
                </tr>
                <tr>
                    <td><span class="input-icon input-icon-right">
            <input type="text" onclick="showTimeAndLabor('table2', this)"/>
            <i class="icon-calendar green"></i>
        </span></td>
                    <td><input type="text"></td>
                    <td><input type="text"></td>
                    <td><input type="text" onblur="isInteger(this, '就餐人数');avgMoney('table2', this)"></td>
                    <td><input type="text" onblur="javascript:addMoney('table2');avgMoney('table2', this)"></td>
                    <td><input type="text" disabled="disabled" value=""></td>
                    <td><input type="text" onblur="isNumber(this, '发票金额')"></td>
                    <td><input type="text" disabled="disabled" onblur="isNumber(this, '工时')"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text"></td>
                    <td><input type='hidden' value=''></td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>金额总计</td>
                    <td><input type="text" value="0.00" id="sum2" readonly="readonly"></td>
                </tr>
                <tr>
                    <td>核定金额总计</td>
                    <td><input type="text" value="0.00" id="ratify2" readonly="readonly"></td>
                </tr>
            </table>
        </div>

    </div>

    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span
                    style="font-size:18px">招待费明细</span></div>
            <table frame="vsides" class="col-xs-12"
                   id="table3">
                <tr>
                    <td bgcolor="#96E0E2">日期</td>
                    <td bgcolor="#96E0E2">地点</td>
                    <td bgcolor="#96E0E2">业务目的</td>
                    <td bgcolor="#96E0E2">客户单位</td>
                    <td bgcolor="#96E0E2">客户姓名</td>
                    <td bgcolor="#96E0E2">参加人数</td>
                    <td bgcolor="#96E0E2">金额</td>
                    <td bgcolor="#96E0E2">核定金额</td>
                    <td bgcolor="#96E0E2">备注</td>
                    <td bgcolor="#96E0E2" width="0"></td>
                    <td bgcolor="#96E0E2"><input type="button" name="Submit" value="添加报销"
                                                 onclick=addRow("table3")></td>
                </tr>
                <tr>
                    <td><span class="input-icon input-icon-right">
            <input type="text" onclick="showTime()"/>
            <i class="icon-calendar green"></i>
        </span></td>
                    <td><input type="text" class="table3"></td>
                    <td><input type="text" class="table3"></td>
                    <td><input type="text" class="table3"></td>
                    <td><input type="text" class="table3"></td>
                    <td><input type="text" class="table3" onblur="isInteger(this, '就餐人数');"></td>
                    <td><input type="text" class="table3" onblur="addMoney('table3')"></td>
                    <td><input type="text" class="table3" disabled="disabled"></td>
                    <td><input type="text" class="table3"></td>
                    <td><input type='hidden' value=''></td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>金额总计</td>
                    <td><input type="text" value="0.00" id="sum3" readonly="readonly"></td>
                </tr>
                <tr>
                    <td>核定金额总计</td>
                    <td><input type="text" value="0.00" id="ratify3" readonly="readonly"></td>
                </tr>
            </table>
        </div>

    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span
                    style="font-size:18px">员工关系费明细</span></div>
            <table frame="vsides" class="col-xs-12"
                   id="table4">
                <tr>
                    <td bgcolor="#96E0E2">日期</td>
                    <td bgcolor="#96E0E2">地点</td>
                    <td bgcolor="#96E0E2">同行人(姓名)</td>
                    <td bgcolor="#96E0E2">活动目的</td>
                    <td bgcolor="#96E0E2">金额</td>
                    <td bgcolor="#96E0E2">核定金额</td>
                    <td bgcolor="#96E0E2">备注</td>
                    <td bgcolor="#96E0E2" width="0"></td>
                    <td bgcolor="#96E0E2"><input type="button" name="Submit" value="添加报销"
                                                 onclick=addRow("table4") class="table4"></td>
                </tr>
                <tr>
                    <td><span class="input-icon input-icon-right">
            <input type="text" onclick="showTime()" class="table4"/>
            <i class="icon-calendar green"></i>
        </span></td>
                    <td><input type="text" class="table4"></td>
                    <td><input type="text" class="table4"></td>
                    <td><input type="text" class="table4"></td>
                    <td><input type="text" onblur="addMoney('table4')" class="table4"></td>
                    <td><input type="text" disabled="disabled" class="table4"></td>
                    <td><input type="text" class="table4"></td>
                    <td><input type='hidden' value='' class="table4"></td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>金额总计</td>
                    <td><input type="text" value="0.00" id="sum4" readonly="readonly"></td>
                </tr>
                <tr>
                    <td>核定总计</td>
                    <td><input type="text" value="0.00" id="ratify4" readonly="readonly"></td>
                </tr>
            </table>
        </div>

    </div>

    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span
                    style="font-size:18px">其他费用</span></div>
            <table frame="vsides" class="col-xs-12"
                   id="table5">
                <tr>
                    <td bgcolor="#96E0E2">费用项目</td>
                    <td bgcolor="#96E0E2">金额</td>
                    <td bgcolor="#96E0E2">核定金额</td>
                    <td bgcolor="#96E0E2">备注</td>
                    <td bgcolor="#96E0E2" width="0"></td>
                    <td bgcolor="#96E0E2"><input type="button" name="Submit" value="添加报销"
                                                 onclick=addRow("table5")></td>
                </tr>
                <tr>
                	<td><input type="text"></td>
                    <td><input type="text" onblur="addMoney('table5')"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text"></td>
                    <td><input type='hidden' value=''></td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>金额总计</td>
                    <td><input type="text" value="0.00" id="sum5" readonly="readonly"></td>
                </tr>
                <tr>
                    <td>核定金额总计</td>
                    <td><input type="text" value="0.00" id="ratify5" readonly="readonly"></td>
                </tr>
            </table>
        </div>
    </div>

</div>
<div class="row">
        <span style="float:right;margin-top:20px;margin-bottom:10px; margin-right:1%;">
            <button class="btn btn-info" type="button"
                    onclick="subTableInfos(false);">
                <i class="icon-arrow-up bigger-110"></i>
                暂存
            </button>
            <button class="btn btn-info" type="button"
                    onclick="subTableInfos(true);">
                <i class="icon-arrow-right bigger-110"></i>
                保存并提交
            </button>
        </span>
</div>
<div id="approve-msg-dialog" class="hide"></div>
<script src="/oaengine/static/js/utils.js"></script>
<script src="/oaengine/static/js/dialog_common.js"></script>
<script src="/oaengine/static/My97DatePicker/WdatePicker.js"></script>
<script language=JavaScript>

	var formId = "$formId";
	var taskId = "$taskId";
	var euid = "$euid";
    jQuery(function ($) {
        var url = location.search;
        if (formId != "") {
            createEditApplyTable(formId);
            
        } else {
            createNewAddApplyTable();
        }

    });

    function showTime() {
        WdatePicker({dateFmt: 'yyyy-MM-dd'});
    }

    function showTimeAndLabor(tableId, curRow) {
        WdatePicker({
            dateFmt: 'yyyy-MM-dd', maxDate: '%y-%M-%d', onpicked: function () {
                workHour(tableId, curRow)
            }
        });
    }

    //  新建表
    function createNewAddApplyTable() {
        $.ajax({
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            url: "oa/employeeinfo",
            type: "GET",
            success: function (resp) {
                if (resp.errorCode == 0) {
                    var data = resp.data;
                    var table = document.getElementById("table");
                    var k = 0;
                    for (var i = 0; i <= 2; i++) {
                        for (var j = 1; j < 6; j += 2) {
                        	if(i==2 && j==1)continue;
                            //if (k >= 5) {
                            //    break;
                            //}
                            table.rows[i].cells[j].childNodes[0].value = data[k];
                            k++;
                        }
                    }
                } else {
                    showCommonNoticeDialog('失败', 'icon-warning-sign',
                            generateNoticeMsg(resp.errorMessage), 300);
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                showCommonNoticeDialog('网络错误', 'icon-bolt',
                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
            }
        });
    }


    function createEditApplyTable(formId) {
        var params = {
            "vars": {
                "formId": formId
            }
        };
        $.ajax({
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            url: "oa/apply_info",
            type: "POST",
            data: JSON.stringify(params),
            success: function (resp) {
                if (resp.errorCode == 0) {
                    var data = resp.data;
                    var tableMap = data.tableMap;
                    var vars = data.vars;
                    getDataToEditDialog(tableMap, vars);
					if(taskId != ""){
		            	$("input[name='Fruit']").attr('disabled', 'true');
			            if($("#sum4").val() <= 0){
			            	$(".table4").attr('disabled', 'true');
			            }
			            if($("#sum3").val() <= 0){
			            	$(".table3").attr('disabled', 'true');
			            }
		            }
                } else {
                    showCommonNoticeDialog('失败', 'icon-warning-sign',
                            generateNoticeMsg(resp.errorMessage), 300);
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                showCommonNoticeDialog('网络错误', 'icon-bolt',
                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
            }
        });
    }


    function constructTable0Info(tableMap) {
        var table0 = tableMap["table"];
        var table = document.getElementById("table");
        var k = 0;
        for (var i = 0; i < 3; i++) {
            for (var j = 1; j < 6; j += 2) {
                var value = table0[0][k];
                if (isNull(value)) {
                    value = "";
                }
                if(i==2 && j==1){
                	if(value == "是"){
                		table.rows[i].cells[j].childNodes[0].checked = true;
                		table.rows[i].cells[j].childNodes[2].checked = false;
                	}else{
                		table.rows[i].cells[j].childNodes[0].checked = false;
                		table.rows[i].cells[j].childNodes[2].checked = true;
                	}
                }else{
                	table.rows[i].cells[j].childNodes[0].value = value;
                }
                k++;
            }
        }

    }
    function constructAllTableInfo(tableMap) {
        var len = 6;
        for (var i = 1; i < len; i++) {
            var tableId = "table" + i;
            var table = document.getElementById(tableId);
            var tableInfo = tableMap[tableId];
            var tableLen = tableInfo.length;
            if (tableLen == 0) { //没有数据,不处理了.
                continue;
            }
//          增加内容
            var rowLen = table.rows.length;
            var coLen = table.rows[0].cells.length;
            for (var j = 0; j < tableLen; j++) {
                var nRow = table.insertRow(rowLen);

                for (var k = 0; k < coLen - 2; k++) {
                    var value = tableInfo[j][k];
                    if (isNull(value)) {
                        value = "";
                    }
                    var cell = nRow.insertCell(k);
                    cell.innerHTML = table.rows[rowLen - 1].cells[k].innerHTML;
                    if(k == 0 && i < 5){
                        console.log(cell.childNodes[0].childNodes);
                        cell.childNodes[0].childNodes[1].value = value;
                    }else{
                        cell.childNodes[0].value = value;
                    }
                }
                cell = nRow.insertCell(coLen - 2);
                cell.innerHTML = "<input type='hidden' value='"+tableInfo[j][100]+"'>";
                cell = nRow.insertCell(coLen - 1);
                cell.innerHTML = "<div align='center' style='width:40px'><a href='javascript:;' " +
                "onclick=\"deleteRow('" + tableId + "',this)\">删除</a></div>";
                rowLen += 1;
            }
            table.deleteRow(1);//删掉第一行.
        }
        
		var table = document.getElementById("table7");
		var tableInfo = tableMap["table7"];
		var tableLen = tableInfo.length;
		for (var j = 0; j < tableLen; j++) {
			$("#loan_"+tableInfo[j][0]).val(tableInfo[j][4]);
		}
    }
    function getDataToEditDialog(tableMap, vars) {

        constructTable0Info(tableMap);
        constructAllTableInfo(tableMap)
        for(var i = 1; i < 7; i++){
            var sumOne = "sum"+i;
            var sum = vars[sumOne];
            $("#"+sumOne).val(sum);
            
            var ratifyOne = "ratify"+i;
            var ratify = vars[ratifyOne];
            $("#"+ratifyOne).val(ratify);
        }
        $("#sum").val(vars["sum"]);
        $("#ratify").val(vars["ratify"]);
        $("#remark").val(vars["remark"]);
		$("#payAmount").val(vars["payAmount"]);
		$("#borrowAmount").val(vars["borrowAmount"]);
    }

    function workHour(tableId, curRow) {
        var table = document.getElementById(tableId);
        var rowId = curRow.parentNode.parentNode.parentNode.rowIndex;
        var dateTime = table.rows[rowId].cells[0].childNodes[0].childNodes[1].value;
        var params = {
            "vars": {
                "day": dateTime
            }
        };
        $.ajax({
            contentType: "application/json; charset=utf-8",
            url: "oa/labor",
            type: "POST",
            data: JSON.stringify(params),
            success: function (resp) {
                console.log(resp);
                if (resp.errorCode == 0) {
                    var data = resp.data;
                    if (tableId == "table1") {
                        table.rows[rowId].cells[6].childNodes[0].value = data[0];
                    } else if (tableId == "table2") {
                        table.rows[rowId].cells[7].childNodes[0].value = data[0];
                    }
                } else {
                    showCommonNoticeDialog('失败', 'icon-warning-sign',
                            generateNoticeMsg(resp.errorMessage), 300);
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                showCommonNoticeDialog('网络错误', 'icon-bolt',
                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
            }
        });
    }
    function addRow(tableId, day, hour) { //读取最后一行的行号，存放在txtTRLastIndex文本框中
        var table = document.getElementById(tableId);
        var rowLen = table.rows.length;
        var coLen = table.rows[0].cells.length;
        var nRow = table.insertRow(rowLen);
        for (var i = 0; i < coLen - 2; i++) {
            var cell = nRow.insertCell(i);
           	cell.innerHTML = table.rows[rowLen - 1].cells[i].innerHTML;
            var flag = false;
	        if(tableId == 'table1'){
		       	if(day != null && i == 0){
		       		cell.childNodes[0].childNodes[1].value = day;
		       	}
				if(hour != null && i == 6){
		       		cell.childNodes[0].value = hour
				}
	        }
	        if(tableId == 'table2'){
		       	if(day != null && i == 0){
		       		cell.childNodes[0].childNodes[1].value = day;
		       	}
				if(hour != null && i == 7){
					cell.childNodes[0].value = hour
				}
	        }
        }
        var cell = nRow.insertCell(coLen - 2);
        cell.innerHTML = "<input type='hidden' value=''>";
        cell = nRow.insertCell(coLen - 1);
        cell.innerHTML = "<input type='hidden' value=''><div align='center' style='width:40px'><a href='javascript:;' " +
        "onclick=\"deleteRow('" + tableId + "',this)\">删除</a></div>";
        addMoney(tableId);
    }


    //删除指定行
    function deleteRow(tableId, curRow) {
        var table = document.getElementById(tableId);
        var rowLen = table.rows.length;
        if(rowLen == 2){
            showCommonNoticeDialog('失败', 'icon-warning-sign',
                    generateNoticeMsg("啊哦,就剩一行了,不能删除了!"), 300);
            return;
        }
        var rowId = curRow.parentNode.parentNode.parentNode.rowIndex;
        table.deleteRow(rowId);
        addMoney(tableId);
    }
    
	function addBorrowAmount(innerSum) {
		if (isNull(innerSum)) {
			innerSum = 0;
		} else if (!(/^(([1-9]\d*)|\d)(\.\d{1,2})?$/).test(innerSum)) {
			showCommonNoticeDialog('错误', 'icon-warning-sign', generateNoticeMsg("冲销金额格式错误"), 300);
			innerSum = 0;
			return false;
		}
        table = document.getElementById("table7");
        var rowLen = table.rows.length;
        borrowAmount = 0;
        for (i = 1; i < rowLen; i++) {
            var price = table.rows[i].cells[4].childNodes[0].value;
            if(isNull(price)) price = 0;
            borrowAmount += parseFloat(price);
        }
        $("#borrowAmount").val(borrowAmount.toFixed(2));
        
        var payAmount = parseFloat($("#sum").val()) - borrowAmount;
        $("#payAmount").val(payAmount.toFixed(2));
    }

    function addMoney(tableId) {
        var tableList = ["table1", "table2", "table3", "table4", "table5", "table6"];
        var errorMsgList = ["出租车费", "餐费", "招待费用", "员工关系费", "其他费用", "通信费"];
        var dic = {};
        for (var i = 0; i < 6; i++) {
            dic[tableList[i]] = errorMsgList[i];
        }
        
        var errorInfo = "";

        if (containsValue(tableList, tableId)) {
            var table = document.getElementById(tableId);
            var rowLen = table.rows.length;
            var coLen = table.rows[0].cells.length;
            var tableSum = 0;
            if(tableId == "table6"){
            	cell = table.rows[0].cells[1].childNodes[0];
            	innerSum = cell.value;
	            if (isNull(innerSum)) {
	            	innerSum = 0;
	            } else if (!(/^(([1-9]\d*)|\d)(\.\d{1,2})?$/).test(innerSum)) {
	            	errorInfo = dic[tableId] + "金额格式错误";
	            	innerSum = 0;
	            	cell.value = "";
	            	cell.style.backgroundColor="yellow";
	            } else {
	            	cell.style.backgroundColor="";
	            }
            }else{
	            for (i = 1; i < rowLen; i++) {
	                var innerSum = '';
	                var cell;
	                if (tableId == "table2") {
	                    cell = table.rows[i].cells[4].childNodes[0];
	                }else {
	                    cell = table.rows[i].cells[coLen - 5].childNodes[0];
	                }
	                innerSum = cell.value;
	                if (isNull(innerSum)) {
	                    innerSum = 0;
	                } else if (!(/^(([1-9]\d*)|\d)(\.\d{1,2})?$/).test(innerSum)) {
	                    errorInfo = dic[tableId] + "金额格式错误";
	            		innerSum = 0;
	            		cell.value = "";
	            		cell.style.backgroundColor="yellow"
	                } else {
	                    innerSum = parseFloat(innerSum);
	                    cell.style.backgroundColor="";
	                }
	                tableSum = parseFloat(tableSum);
	                tableSum += innerSum;
	            }
	            var length = tableId.length;
	            var id = tableId.substr(length - 1);
	            $("#sum" + id).val(tableSum.toFixed(2));
            }
        }

        var sum = 0;
        for (i = 1; i < 7; i++) {
            var innerSum = $("#sum" + i).val();
            if (isNull(innerSum)) {
                innerSum = 0.00;
            } else {
                innerSum = parseFloat(innerSum);
            }
            sum = parseFloat(sum);
            sum += innerSum;
        }
        $("#sum").val(sum.toFixed(2));
        var payAmount = sum - parseFloat($("#borrowAmount").val());
        $("#payAmount").val(payAmount.toFixed(2));
        if(errorInfo != ""){
			showCommonNoticeDialog('错误', 'icon-warning-sign',
                            generateNoticeMsg(errorInfo), 300);
	        return false;
        }
    }

    function avgMoney(tableId, curRow) {
        var table = document.getElementById(tableId);
        var rowId = curRow.parentNode.parentNode.rowIndex;
        var num = table.rows[rowId].cells[3].childNodes[0].value;
        var money = table.rows[rowId].cells[4].childNodes[0].value;
        if (!isNull(num) && !isNull(money)) {
            var evMoney = parseFloat(money) / parseInt(num);
            console.log(evMoney);
            evMoney = parseFloat(evMoney);
            table.rows[rowId].cells[5].childNodes[0].value = evMoney.toFixed(2);
        }
    }

    function subTableInfos(flag) {
        var params = {};
        var vars = {};
        if(formId != null && formId != ""){
        	vars["formId"] = formId;
        }
        for (var i = 1; i < 7; i++) {
            vars["sum" + i] = $("#sum" + i).val();
        }
        for (var i = 1; i < 7; i++) {
            vars["ratify" + i] = $("#ratify" + i).val();
        }
        vars["sum"] = $("#sum").val();
        vars["ratify"] = $("#ratify").val();
        vars["remark"] = $("#remark").val();
        vars["payAmount"] = $("#payAmount").val();
        var tableMap = {};
        var tableList = ["table1", "table2", "table3", "table4", "table5"];
        var len = tableList.length;
        for (i = 0; i < len; i++) {
            var tableId = tableList[i];
            var table = document.getElementById(tableId);
            var rowLen = table.rows.length;
            var coLen = table.rows[0].cells.length;
            var list = new Array();
            for (var j = 1; j < rowLen; j++) {
                list[j - 1] = new Array();
                for (var k = 0; k < coLen - 1; k++) {
                    list[j - 1][k] = table.rows[j].cells[k].childNodes[0].value;
                    if (tableId != "table5" && k == 0) {
                         _data = table.rows[j].cells[k].childNodes[0].childNodes[1].value;
                         list[j - 1][k] = _data;
                    }
                    if (isNull(list[j - 1][k])) {
                        list[j - 1][k] = "";
                    }
                }
            }
            tableMap[tableId] = list;
        }
        //table 基本信息
        table = document.getElementById("table");
        list = new Array();
        list[0] = new Array();
        k = 0;
        for (i = 0; i < 3; i++) {
            for (j = 1; j < 6; j += 2) {
                if ((i == 2) && j == 1) {
                    var input = table.rows[i].cells[j].childNodes;
                    var input1 = input[0];
                    var input2 = input[2];
                    if (input1.checked) {
                        list[0][k] = input1.value;
                    } else if (input2.checked) {
                        list[0][k] = input2.value;
                    }
                } else {
                    list[0][k] = table.rows[i].cells[j].childNodes[0].value;
                }
                if (isNull(list[0][k])) {
                    list[0][k] = "";
                }
                k++;
            }
        }
        tableMap["table"] = list;
        
        //table 借款信息
        table = document.getElementById("table7");
        list = new Array();
        list[0] = new Array();
        var rowLen = table.rows.length;
        k = 0;
        priceSum = 0;
        for (i = 1; i < rowLen; i++) {
            var billNo = table.rows[i].cells[0].childNodes[0].value;
            var invoiceDate = table.rows[i].cells[1].childNodes[0].value;
            var amount = table.rows[i].cells[2].childNodes[0].value;
            var borrowBillBalance = table.rows[i].cells[3].childNodes[0].value;
            var price = table.rows[i].cells[4].childNodes[0].value;
            if(price == "") price = "0.00";
            if (!(/^(([1-9]\d*)|\d)(\.\d{1,2})?$/).test(price)) {
				showCommonNoticeDialog('失败', 'icon-warning-sign', generateNoticeMsg("冲销金额格式错误"), 300);
				return false;
			}
			borrowBillBalance = parseFloat(borrowBillBalance);
			price = parseFloat(price);
			priceSum += price;
			if (price > borrowBillBalance) {
				showCommonNoticeDialog('失败', 'icon-warning-sign', generateNoticeMsg("冲销金额不能大于借款余额"), 300);
				return false;
			}
            list[0][k] = billNo+","+invoiceDate+","+amount+","+borrowBillBalance+","+price;
            k++;
        }
        tableMap["table7"] = list;
        
        params["vars"] = vars;
        params["tableMap"] = tableMap;
        params["flag"] = flag;
        $.ajax({
            contentType: "application/json; charset=utf-8",
            url: "oa/data",
            type: "POST",
            data: JSON.stringify(params),
            success: function (resp) {
                if (resp.errorCode == 0) {
                	if(flag && taskId != null && taskId != ""){
                		//approveProxy("oa/approve_endorse");
                		approveEndorse();
                	}else if(flag){
                    	showCommonNoticeDialog('成功', 'icon-warning-sign', generateNoticeMsg("创建报销申请成功！"), 300);
                    	window.location.href = '/oaengine/oa/apply_todo.html';
                    }else{
                    	if(taskId != null && taskId != ""){
                    		showCommonNoticeDialog('成功', 'icon-warning-sign', generateNoticeMsg("保存成功！"), 300);
	                    	window.location.href = '/oaengine/oa/approve_todo.html';   
                    	}else{
	                        showCommonNoticeDialog('成功', 'icon-warning-sign', generateNoticeMsg("草稿保存成功！"), 300);
	                    	window.location.href = '/oaengine/oa/draft.html';    
                    	}           
                    }
                } else {
                    showCommonNoticeDialog('失败', 'icon-warning-sign',
                            generateNoticeMsg(resp.errorMessage), 300);
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                showCommonNoticeDialog('网络错误', 'icon-bolt',
                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
            }
        })
    }
    
     function approveEndorse() {
        var url = "oa/approve_endorse";
        var dialog_width = Math.min(Math.round(window.screen.width * 0.7), 900);
        try {
            $("#approve-msg-dialog").empty();
            var form = createOperateMsgForm('Tips: 备注不要超过100个字符');
            $("#approve-msg-dialog").append(form);
            var dialog = $("#approve-msg-dialog").removeClass('hide').dialog({
                modal: true,
                width: dialog_width,
                height: 250,
                title: '<div style="color: DodgerBlue; padding: 4px; height: 28px; font-size: 14px; font-weight: bold">' +
                '<li class="icon-user"></li> 备注</div>',
                title_html: true,
                closeOnEscape: false,
                open: function (event, ui) {
                    $(".ui-dialog-titlebar-close").hide();
                },
                buttons: [
                    {
                        id: "approve-msg-submit",
                        text: "提交",
                        "class": "btn btn-primary btn-xs",
                        click: function (e) {
                            try {
                                var this_form = $("#approve-msg-dialog").find("form");
                                var postData = this_form.serializeArray();
                                var msg = "";
                                for (var i in postData) {
                                    if (postData[i]['name'] == 'msg') {
                                        if (postData[i]['value'].length >= 100) {
                                            showCommonNoticeDialog('备注错误', 'icon-warning-sign', generateNoticeMsg('备注不能超过100个字符'), 300);
                                            return;
                                        } else {
                                            msg = postData[i]['value'];
                                            break;
                                        }
                                    }
                                }
                                approveProxy(url, msg);
                                e.preventDefault(); 
                                $(this).dialog("close");
                            } catch (e) {
                                showCommonNoticeDialog('网络错误', 'icon-warning-sign',
                                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
                            }
                        }
                    },
                    {
                        id: "approve-msg-cancel",
                        text: "取消",
                        "class": "btn btn-xs",
                        click: function () {
                            $(this).dialog("close");
                        }
                    }
                ]
            });
        } catch (e) {
        	alert(e)
            showCommonNoticeDialog('网络错误', 'icon-warning-sign', generateNoticeMsg('网络错误，请刷新后重试!'), 300);
        }
    }

	function approveProxy(url, memo) {
        var params = {};
        var vars = {};
        vars["formIds"] = formId;
        vars["taskIds"] = taskId;
        vars["memo"] = memo;
        vars["rtx_id"] = euid;
        params["vars"] = vars;
        $.ajax({
            contentType: "application/json; charset=utf-8",
            url: url,
            type: "post",
            data: JSON.stringify(params),
            success: function (resp) {
                var title_html_str = '';
                try {
                    if (resp.errorCode == 0) {
                        showCommonNoticeDialog('处理成功', 'icon-warning-sign',
                        generateNoticeMsg('处理成功'), 300);
                		window.location.href = '/oaengine/oa/approve_todo.html';
                    } else {
                        showCommonNoticeDialog('处理失败', 'icon-warning-sign',
                        generateNoticeMsg(resp.errorMessage), 300);
                    }
                } catch (e) {
                }
            },
            "error": function (jqxhr, textstatus, errorthrown) {
                showCommonNoticeDialog('网络错误', 'icon-warning-sign',
                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
            }
        });
    }
    
    function isNumber(cell, field){
    	if (cell.value != '' && !(/^(([1-9]\d*)|\d)(\.\d{1,2})?$/).test(cell.value)) {
			alert(field + "格式错误");
			cell.value = "";
			return false;
		}
    }
    
    function isInteger(cell, field){
    	if (!(/^(([1-9]\d*)|\d)?$/).test(cell.value)) {
			alert(field + "格式错误");
			cell.value = "";
			return false;
		}
    }
    
    function createOperateMsgForm(msg) {
        var tips = msg;
        var form = '<form style="width: 100%; background-color: white"> ';
        form += '<div>';
        form += $.parseStr('<textarea class="form-control" name="msg" style="height: 100px;" placeholder="%s"></textarea>', tips);
        form += '</div>';
        form += '</form>';
        return form;
    }
    
    function autoFill(tableId){
    	var start = $("#auto-file-date-from-"+tableId).val();
    	var end = $("#auto-file-date-to-"+tableId).val();
    	if(start=='' || end==''){
    		showCommonNoticeDialog('错误', 'icon-warning-sign', generateNoticeMsg('请填写开始时间和结束时间!'), 300);
    		return false;
    	}
    	if(end < start){
    		showCommonNoticeDialog('错误', 'icon-warning-sign', generateNoticeMsg('结束时间不能小于开始时间!'), 300);
    		return false;
    	}
        var params = {
            "vars": {
                "start": start,
                "end": end,
            }
        };
        $.ajax({
            contentType: "application/json; charset=utf-8",
            url: "oa/batch_labor",
            type: "POST",
            data: JSON.stringify(params),
            success: function (resp) {
                console.log(resp);
                if (resp.errorCode == 0) {
                    var data = resp.data;
                    if(data.length > 0){
                    	var table = document.getElementById(tableId);
        				var rowLen = table.rows.length;
        				if(rowLen == 2){
        					info = data[0];
		                    vals = info.split(":");
		                    day = vals[0];
		                    hour = vals[1];
		                    if(tableId == "table1"){
        						//table.rows[1].cells[0].innerHTML = '<span class="input-icon input-icon-right"><input type="text" value="'+day+'" onclick="showTimeAndLabor(\'table1\', this)"/><i class="icon-calendar green"></i></span>';
								//table.rows[1].cells[6].innerHTML = '<td><input type="text" disabled="disabled" value="'+hour+'"></td>';
								table.rows[1].cells[0].childNodes[0].childNodes[1].value = day;
								table.rows[1].cells[6].childNodes[0].value = hour
        					}
        					if(tableId == "table2"){
        						//table.rows[1].cells[0].innerHTML = '<span class="input-icon input-icon-right"><input type="text" value="'+day+'" onclick="showTimeAndLabor(\'table2\', this)"/><i class="icon-calendar green"></i></span>';
								//table.rows[1].cells[6].innerHTML = '<td><input type="text" disabled="disabled" value="'+hour+'"></td>';
								table.rows[1].cells[0].childNodes[0].childNodes[1].value = day;
								table.rows[1].cells[7].childNodes[0].value = hour
        					}
        					for(var i=1; i<data.length; i++){
		                    	info = data[i];
		                    	vals = info.split(":");
		    					addRow(tableId, vals[0], vals[1]);
		                    }
        				}else{
		                    for(var i=0; i<data.length; i++){
		                    	info = data[i];
		                    	vals = info.split(":");
		    					addRow(tableId, vals[0], vals[1]);
		                    }
	                    }
                    }else{
                    	showCommonNoticeDialog('自动填写', 'icon-warning-sign', generateNoticeMsg("你没有大于11.5小时的考勤记录"), 300);
                    }
                } else {
                    showCommonNoticeDialog('失败', 'icon-warning-sign', generateNoticeMsg(resp.errorMessage), 300);
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                showCommonNoticeDialog('网络错误', 'icon-bolt', generateNoticeMsg('网络错误，请刷新后重试!'), 300);
            }
        });
    	
    }
</script>
