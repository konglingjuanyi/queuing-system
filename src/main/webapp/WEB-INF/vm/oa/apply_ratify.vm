#set($layout = "layout/oa_layout.vm")
<style type="text/css">
    td input {
        width: 100%;
        text-align: center;
        color: red;
        font-size: larger;
    }

    td {
        text-align: center;
    }

</style>
<div class="col-xs-32">
    <!-- PAGE CONTENT BEGINS -->
    <div style="text-align: center" class="col-xs-32">
        <h3 class="header smaller lighter blue" style="margin-left: auto;margin-right: auto;">日常费用报销单</h3>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span
                    style="font-size:18px">个人基本信息</span></div>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12"
                   id="table">
                <tr>
                    <td>申请人</td>
                    <td><input type="text" readonly="readonly"></td>
                    <td>员工编号</td>
                    <td><input type="text" readonly="readonly"></td>
                    <td>申请日期</td>
                    <td><input type="text" style="color:red" readonly="readonly"></td>
                </tr>
                <tr>
                    <td>一级部门</td>
                    <td><input type="text" readonly="readonly"></td>
                    <td>申请部门</td>
                    <td><input type="text" readonly="readonly"></td>
                    <td>部门编号</td>
                    <td><input type="text" readonly="readonly"></td>
                </tr>
                <tr>
                    <td>是否直接向VP汇报</td>
                    <td>
                        <form action="" method="get">
                            <input disabled="disabled" name="Fruit" type="radio" checked="false" style="width:25% !important"
                                   value="是"/><span style="width:10%">是</span>
                            <input disabled="disabled" name="Fruit" type="radio" checked="true" style="width:25% !important"
                                   value="否"/><span style="width:10%">否</<span>
                        </form>
                    </td>
                    <td>银行卡号</td>
                    <td><input type="text" readonly="readonly"></td>
                    <td>银行开户行</td>
                    <td><input type="text" readonly="readonly"></td>
                </tr>
                <!--
                <tr>
                    <td>是否有借款</td>
                    <td>
                        <form action="" method="get">
                            <input name="Fruit" type="radio" checked="false" style="width:25% !important"
                                   value="是"/><span style="width:10%">是</span>
                            <input name="Fruit" type="radio" checked="true" style="width:25% !important"
                                   value="否"/><span style="width:10%">否</<span>
                        </form>
                    </td>
                    <td>借款单流水号</td>
                    <td><input type="text" readonly="readonly"></td>
                    <td>借款金额</td>
                    <td><input type="text" readonly="readonly"></td>
                </tr>
                <tr>
                -->
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>报销金额总计</td>
                    <td><input type="text" value="0.00" id="sum" readonly="readonly"></td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>核定金额总计</td>
                    <td><input type="text" value="0.00" id="ratify" readonly="readonly"></td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>&nbsp;&nbsp;支付金额&nbsp;&nbsp;</td>
                    <td><input type="text" value="0.00" id="payAmount" onblur="payAmount()"></td>
                </tr>
            </table>        
        </div>

    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span
                    style="font-size:18px">出租车费明细(含汽车燃油费)</span></div>
            <table frame="vsides" class="col-xs-12"
                   id="table1">
                <tr>
                    <td bgcolor="#96E0E2">日期</td>
                    <td bgcolor="#96E0E2">起点</td>
                    <td bgcolor="#96E0E2">终点</td>
                    <td bgcolor="#96E0E2">具体时间</td>
                    <td bgcolor="#96E0E2">用途</td>
                    <td bgcolor="#96E0E2">同行人(姓名)</td>
                    <td bgcolor="#96E0E2">工时</td>
                    <td bgcolor="#96E0E2">金额</td>
                    <td bgcolor="#96E0E2">核定金额</td>
                    <td bgcolor="#96E0E2">备注</td>
                    <td bgcolor="#96E0E2" width="0"></td>
                </tr>
                <tr>
                    <td><span class="input-icon input-icon-right">
            <input type="text" disabled="disabled" onclick="showTimeAndLabor('table1', this)"/>
            <i class="icon-calendar green"></i>
        </span></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" onblur="addMoney('table1')"></td>
                    <td><input type="text" ></td>
                    <td><input type='text' value='' type='hidden'></td>

                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>金额总计</td>
                    <td><input type="text" value="0.00" id="sum1" readonly="readonly"></td>
                </tr>
                <tr>
                    <td>核定金额总计</td>
                    <td><input type="text" value="0.00" id="ratify1" readonly="readonly"></td>
                </tr>
            </table>
        </div>

    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span
                    style="font-size:18px">通信费</span></div>
            <table frame="vsides" class="col-xs-12"
                   id="table6">
                <tr>
                    <td>金额</td>
                    <td><input type="text" value="0.00" disabled="disabled"></td>
                    <td>核定金额</td>
                    <td><input type="text" value="0.00" id="ratify6" onblur="addMoney('table6')"></td>
                    <td>备注(话费实际发生月份)</td>
                    <td><input type="text" id="remark"></td>
                </tr>
            </table>
        </div>

    </div>

    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span
                    style="font-size:18px">餐费明细(每人每餐报销不超过50元)</span></div>
            <table frame="vsides" class="col-xs-12"
                   id="table2">
                <tr>
                    <td bgcolor="#96E0E2">日期</td>
                    <td bgcolor="#96E0E2">就餐地点</td>
                    <td bgcolor="#96E0E2">同行人(姓名)</td>
                    <td bgcolor="#96E0E2">就餐人数</td>
                    <td bgcolor="#96E0E2">实报金额</td>
                    <td bgcolor="#96E0E2">人均餐费</td>
                    <td bgcolor="#96E0E2">发票金额</td>
                    <td bgcolor="#96E0E2">工时</td>
                    <td bgcolor="#96E0E2">核定金额</td>
                    <td bgcolor="#96E0E2">备注</td>
                    <td bgcolor="#96E0E2" width="0"></td>
                </tr>
                <tr>
                    <td><span class="input-icon input-icon-right">
            <input disabled="disabled" type="text" onclick="showTimeAndLabor('table2', this)"/>
            <i class="icon-calendar green"></i>
        </span></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" onblur="addMoney('table2')"></td>
                    <td><input type="text"></td>
                    <td><input type='text' value=''></td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>金额总计</td>
                    <td><input type="text" value="0.00" id="sum2" readonly="readonly"></td>
                </tr>
                <tr>
                    <td>核定金额总计</td>
                    <td><input type="text" value="0.00" id="ratify2" readonly="readonly"></td>
                </tr>
            </table>
        </div>

    </div>

    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span
                    style="font-size:18px">招待费明细</span></div>
            <table frame="vsides" class="col-xs-12"
                   id="table3">
                <tr>
                    <td bgcolor="#96E0E2">日期</td>
                    <td bgcolor="#96E0E2">地点</td>
                    <td bgcolor="#96E0E2">业务目的</td>
                    <td bgcolor="#96E0E2">客户单位</td>
                    <td bgcolor="#96E0E2">客户姓名</td>
                    <td bgcolor="#96E0E2">参加人数</td>
                    <td bgcolor="#96E0E2">金额</td>
                    <td bgcolor="#96E0E2">核定金额</td>
                    <td bgcolor="#96E0E2">备注</td>
                    <td bgcolor="#96E0E2" width="0"></td>
                </tr>
                <tr>
                    <td><span class="input-icon input-icon-right">
            <input disabled="disabled" type="text" onclick="showTime()"/>
            <i class="icon-calendar green"></i>
        </span></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" onblur="addMoney('table3')"></td>
                    <td><input type="text"></td>
                    <td><input type='text' value=''></td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>金额总计</td>
                    <td><input type="text" value="0.00" id="sum3" readonly="readonly"></td>
                </tr>
                <tr>
                    <td>核定金额总计</td>
                    <td><input type="text" value="0.00" id="ratify3" readonly="readonly"></td>
                </tr>
            </table>
        </div>

    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span
                    style="font-size:18px">员工关系费明细</span></div>
            <table frame="vsides" class="col-xs-12"
                   id="table4">
                <tr>
                    <td bgcolor="#96E0E2">日期</td>
                    <td bgcolor="#96E0E2">地点</td>
                    <td bgcolor="#96E0E2">同行人(姓名)</td>
                    <td bgcolor="#96E0E2">活动目的</td>
                    <td bgcolor="#96E0E2">金额</td>
                    <td bgcolor="#96E0E2">核定金额</td>
                    <td bgcolor="#96E0E2">备注</td>
                    <td bgcolor="#96E0E2" width="0"></td>
                </tr>
                <tr>
                    <td><span class="input-icon input-icon-right">
            <input disabled="disabled" type="text" onclick="showTime()"/>
            <i class="icon-calendar green"></i>
        </span></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" onblur="addMoney('table4')"></td>
                    <td><input type="text"></td>
                    <td><input type='text' value=''></td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>金额总计</td>
                    <td><input type="text" value="0.00" id="sum4" readonly="readonly"></td>
                </tr>
                <tr>
                    <td>核定金额总计</td>
                    <td><input type="text" value="0.00" id="ratify4" readonly="readonly"></td>
                </tr>
            </table>
        </div>

    </div>

    <div class="row">
        <div class="col-sm-12">
            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span
                    style="font-size:18px">其他费用</span></div>
            <table frame="vsides" class="col-xs-12"
                   id="table5">
                <tr>
                    <td bgcolor="#96E0E2">费用项目</td>
                    <td bgcolor="#96E0E2">金额</td>
                    <td bgcolor="#96E0E2">核定金额</td>
                    <td bgcolor="#96E0E2">备注</td>
                    <td bgcolor="#96E0E2" width="0"></td>
                </tr>
                <tr>
                	<td><input type="text" disabled="disabled"></td>
                    <td><input type="text" disabled="disabled"></td>
                    <td><input type="text" onblur="addMoney('table5')"></td>
                    <td><input type="text"></td>
                    <td><input type='text' value=''></td>
                </tr>
            </table>
            <table style="border-collapse:collapse;" border="1" class="col-xs-12">
                <tr>
                    <td>金额总计</td>
                    <td><input type="text" value="0.00" id="sum5" readonly="readonly"></td>
                </tr>
                <tr>
                    <td>核定金额总计</td>
                    <td><input type="text" value="0.00" id="ratify5" readonly="readonly"></td>
                </tr>
            </table>
        </div>
    </div>
    
	    <div class="row">
	        <div class="col-sm-12">
	            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"><span style="font-size:18px">冲销借款</span></div>
	            <table frame="vsides" class="col-xs-12" id="table7">
	                <tr>
	                    <td bgcolor="#96E0E2">借款编号</td>
	                    <td bgcolor="#96E0E2">借款金额</td>
	                </tr>
	                #foreach($loan in $loans)
	                <tr>
	                    <td>$loan[1]</td>
	                    <td>$loan[2]</td>
	                </tr>
					#end
	            </table>
	            <div class="col-xs-12" style="border:solid 1px; background-color: #f0f0f0;text-align: center;"></div>
	        </div>
	    </div>
</div>
<div class="row">
    <div class="col-sm-12">
    	<span style="float:left;margin-top:20px;margin-bottom:10px; margin-right:1%;">
        	<button class="btn btn-info" type="button" onclick="history.back();;">
               	 返回
            </button>
            <button class="btn btn-info" type="button"
                    onclick="subTableInfos(false, false);">
               	 保存
            </button>
    	</span>
        <span style="float:right;margin-top:20px;margin-bottom:10px; margin-right:1%;">
            <button class="btn btn-info" type="button"
                    onclick="subTableInfos(false, true);">
               	 通过
            </button>
            <button class="btn btn-info" type="button"
                    onclick="approveReject();">
               	 拒绝
            </button>
            <button class="btn btn-info" type="button"
                    onclick="approveBack();">
               	 退回
            </button>
            <button class="btn btn-info" type="button"
                    onclick="approveEndorse();">
               	 加签
            </button>
        </span>
    </div>
</div>

<div id="dialog-confirm" class="hide">
    <form class="form-horizontal">
        <div id="edit-form">
            <div id="edit_content" align="center">
            </div>
        </div>
    </form>
</div>

<div id="approve-result-dialog" class="hide"></div>
<div id="reject-msg-dialog" class="hide"></div>
<div id="approve-msg-dialog" class="hide"></div>
<div id="back-msg-dialog" class="hide"></div>
<div id="endorse-msg-dialog" class="hide"></div>

<div id="common-notice-dialog" class="hide"></div>

<script src="/oaengine/static/js/utils.js"></script>
<script src="/oaengine/static/js/dialog_common.js"></script>
<script src="/oaengine/static/js/approve_common.js"></script>
<script src="/oaengine/static/My97DatePicker/WdatePicker.js"></script>
<script language=JavaScript>

	var formId = "$formId";
	var taskId = "$taskId";
    jQuery(function ($) {
    	createEditApplyTable(formId);
    });
    
	function generateNoticeMsg(msg) {
	    return $.parseStr('<div class="alert alert-info bigger-110" style="margin-bottom: 0px; margin-top: 5px;">%s</div>', msg);
	}
	
    function createEditApplyTable(formId) {
        var params = {
            "vars": {
                "formId": formId
            }
        };
        $.ajax({
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            url: "oa/apply_info",
            type: "POST",
            data: JSON.stringify(params),
            success: function (resp) {
                if (resp.errorCode == 0) {
                    var data = resp.data;
                    var tableMap = data.tableMap;
                    var vars = data.vars;
                    getDataToEditDialog(tableMap, vars);

                } else {
                    showCommonNoticeDialog('失败', 'icon-warning-sign',
                            generateNoticeMsg(resp.errorMessage), 300);
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                showCommonNoticeDialog('网络错误', 'icon-bolt',
                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
            }
        });
    }


    function constructTable0Info(tableMap) {
        var table0 = tableMap["table"];
        var table = document.getElementById("table");
        var k = 0;
        for (var i = 0; i < 3; i++) {
            for (var j = 1; j < 6; j += 2) {
                var value = table0[0][k];
                if (isNull(value)) {
                    value = "";
                }
                table.rows[i].cells[j].childNodes[0].value = value;
                k++;
            }
        }

    }
    function constructAllTableInfo(tableMap) {
        var len = 6;
        for (var i = 1; i < len; i++) {
            var tableId = "table" + i;
            var table = document.getElementById(tableId);
            var tableInfo = tableMap[tableId];
            var tableLen = tableInfo.length;
            if (tableLen == 0) { //没有数据,不处理了.
            	table.deleteRow(1);//删掉第一行.
                continue;
            }
//          增加内容
            var rowLen = table.rows.length;
            var coLen = table.rows[0].cells.length;
            for (var j = 0; j < tableLen; j++) {
                var nRow = table.insertRow(rowLen);

                for (var k = 0; k < coLen - 1; k++) {
                    var value = tableInfo[j][k];
                    if (isNull(value)) {
                        value = "";
                    }
                    var cell = nRow.insertCell(k);
                    cell.innerHTML = table.rows[rowLen - 1].cells[k].innerHTML;
                    if(k == 0 && i < 5){
                        console.log(cell.childNodes[0].childNodes);
                        cell.childNodes[0].childNodes[1].value = value;
                    }else{
                        cell.childNodes[0].value = value;
                    }
                }
                cell = nRow.insertCell(coLen - 1);
                cell.innerHTML = "<input type='hidden' value='"+tableInfo[j][100]+"'>";

                rowLen += 1;
            }
            table.deleteRow(1);//删掉第一行.
        }
    }
    function getDataToEditDialog(tableMap, vars) {

        constructTable0Info(tableMap);
        constructAllTableInfo(tableMap)
        for(var i = 1; i < 7; i++){
            var sumOne = "sum"+i;
            var sum = vars[sumOne];
            $("#"+sumOne).val(sum);
            var ratifyOne = "ratify"+i;
            var ratify = vars[ratifyOne];
            $("#"+ratifyOne).val(ratify);
        }
        $("#sum").val(vars["sum"]);
        $("#ratify").val(vars["ratify"]);
        $("#remark").val(vars["remark"]);
		$("#payAmount").val(vars["payAmount"]);
    }


    function addMoney(tableId) {
        var tableList = ["table1", "table2", "table3", "table4", "table5", "table6"];
        var errorMsgList = ["出租车费", "餐费", "招待费用", "员工关系费", "其他费用", "通信费"];
        var dic = {};
        for (var i = 0; i < 6; i++) {
            dic[tableList[i]] = errorMsgList[i];
        }

        if (containsValue(tableList, tableId)) {
            var table = document.getElementById(tableId);
            var rowLen = table.rows.length;
            var coLen = table.rows[0].cells.length;
            var tableSum = 0;
            if(tableId == "table6"){
            	cell = table.rows[0].cells[3].childNodes[0];
            	innerSum = cell.value;
	            if (isNull(innerSum)) {
	            	innerSum = 0;
	            }else if (!(/^(([1-9]\d*)|\d)(\.\d{1,2})?$/).test(innerSum)) {
	                alert(dic[tableId] + "金额格式错误");
	                cell.value = "";
	                return false;
	            }
	            $("#ratify6").val(parseFloat(innerSum).toFixed(2));
            }else{
	            for (i = 1; i < rowLen; i++) {
	                var innerSum = '';
	                var amount = 0;
	                var cell = table.rows[i].cells[coLen - 3].childNodes[0];
	                innerSum = cell.value;
	                if (tableId == "table2") {
	                    amount = table.rows[i].cells[4].childNodes[0].value;
	                }else {
	                    amount = table.rows[i].cells[coLen - 4].childNodes[0].value;
	                }
	                var regexp = new RegExp("^[0-9.]*$")
	                if (isNull(innerSum)) {
	                    innerSum = 0;
	                }else if (!(/^(([1-9]\d*)|\d)(\.\d{1,2})?$/).test(innerSum)) {
		                alert(dic[tableId] + "金额格式错误");
		                cell.value = "";
		                return false;
		            }else {
	                    innerSum = parseFloat(innerSum);
	                }
	                amount = parseFloat(amount);
	                if(innerSum > amount){
	                	alert("核定金额不能大于申请金额");
	                	cell.value = "";
	                	return false;
	                }
	                tableSum = parseFloat(tableSum);
	                tableSum += innerSum;
	            }
	            tableSum
	            var length = tableId.length;
	            var id = tableId.substr(length - 1);
	            $("#ratify" + id).val(tableSum.toFixed(2));
            }
        }

        var sum = 0;
        for (i = 1; i < 7; i++) {
            var innerSum = $("#ratify" + i).val();
            if (isNull(innerSum)) {
                innerSum = 0.00;
            } else {
                innerSum = parseFloat(innerSum);
            }
            sum = parseFloat(sum);
            sum += innerSum;
        }
        $("#ratify").val(sum.toFixed(2));
    }

    function subTableInfos(flag, pass) {
        var params = {};
        var vars = {};
        vars["is_ratify"] = "true";
        if(formId != null){
        	vars["formId"] = formId;
        }
        for (var i = 1; i < 7; i++) {
            vars["sum" + i] = $("#sum" + i).val();
        }
        for (var i = 1; i < 7; i++) {
            vars["ratify" + i] = $("#ratify" + i).val();
        }
        vars["sum"] = $("#sum").val();
        vars["ratify"] = $("#ratify").val();
        vars["remark"] = $("#remark").val();
        vars["payAmount"] = $("#payAmount").val();
        var tableMap = {};
        var tableList = ["table1", "table2", "table3", "table4", "table5"];
        var len = tableList.length;
        for (i = 0; i < len; i++) {
            var tableId = tableList[i];
            var table = document.getElementById(tableId);
            var rowLen = table.rows.length;
            var coLen = table.rows[0].cells.length;
            var list = new Array();
            for (var j = 1; j < rowLen; j++) {
                list[j - 1] = new Array();
                for (var k = 0; k < coLen; k++) {
                    list[j - 1][k] = table.rows[j].cells[k].childNodes[0].value;
                    if (tableId != "table5" && k == 0) {
                        list[j - 1][k] = table.rows[j].cells[k].childNodes[0].childNodes[1].value;
                    }
                    if (isNull(list[j - 1][k])) {
                        list[j - 1][k] = "";
                    }
                }
            }
            tableMap[tableId] = list;
        }
        //table 基本信息
        table = document.getElementById("table");
        list = new Array();
        list[0] = new Array();
        k = 0;
        for (i = 0; i < 3; i++) {
            for (j = 1; j < 6; j += 2) {
                if ((i == 2 || i == 3) && j == 1) {
                	console.log()
                    var input = table.rows[i].cells[j].childNodes[1].childNodes;
                    var input1 = input[1];
                    var input2 = input[4];
                    if (input1.checked) {
                        list[0][k] = input1.value;
                    } else if (input2.checked) {
                        list[0][k] = input2.value;
                    }
                } else {
                    list[0][k] = table.rows[i].cells[j].childNodes[0].value;
                }
                if (isNull(list[0][k])) {
                    list[0][k] = "";
                }
                k++;
            }
        }
        tableMap["table"] = list;

        params["vars"] = vars;
        params["tableMap"] = tableMap;
        params["flag"] = flag;
        $.ajax({
            contentType: "application/json; charset=utf-8",
            url: "oa/ratify",
            type: "POST",
            data: JSON.stringify(params),
            success: function (resp) {
                if (resp.errorCode == 0) {
                	if(pass){
                    	approveProxy("oa/approve_pass", "", "通过");
                    }else{
                    	showCommonNoticeDialog('成功', 'icon-warning-sign', generateNoticeMsg("保存成功！"), 300);
                    	window.location.href = '/oaengine/oa/approve_todo.html';
                    }
                } else {
                    showCommonNoticeDialog('失败', 'icon-warning-sign',
                            generateNoticeMsg(resp.errorMessage), 300);
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                showCommonNoticeDialog('网络错误', 'icon-bolt',
                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
            }
        })
    }
    
    function approveProxy(url, msg, action, rtx_id) {
        var params = {};
        var vars = {};
        vars["formIds"] = formId;
        vars["taskIds"] = taskId;
        vars["memo"] = msg;
        vars["rtx_id"] = rtx_id;
        params["vars"] = vars;
        $.ajax({
            contentType: "application/json; charset=utf-8",
            url: url,
            type: "post",
            data: JSON.stringify(params),
            success: function (resp) {
                var title_html_str = '';
                try {
                    if (resp.errorCode == 0) {
                        title_html_str = '<div class="dialog_title"><li class="icon-info-sign"></li> 审批' + action + '</div>';
                        var succeed_html = '<b><li class="icon-check"></li> ' + action + '成功</b><br/>';
                        $("#approve-result-dialog").append(generateNoticeMsg(succeed_html));
                    } else {
                        title_html_str = '<div class="dialog_title"><li class="icon-exclamation-sign"></li>审批' + action + '</div>';
                        $("#approve-result-dialog").append(generateNoticeMsg(resp.errorMessage));
                    }
                } catch (e) {
                }
                var dialog = $("#approve-result-dialog").removeClass('hide').dialog({
                    modal: true,
                    width: 400,
                    resizable: true,
                    title: title_html_str,
                    title_html: true,
                    closeOnEscape: false,
                    buttons: [
                        {
                            text: "确定",
                            "class": "btn btn-primary btn-xs",
                            click: function () {
                                $("#approve-result-dialog").empty();
                                $("#approve-result-dialog").dialog('destroy');
                                window.location.href = '/oaengine/oa/approve_todo.html';
                            }
                        }
                    ],
                    close: function () {
                        $("#approve-result-dialog").empty();
                        $("#approve-result-dialog").dialog('destroy');
                        window.location.href = '/oaengine/oa/approve_todo.html';
                    }
                });
            },
            "error": function (jqxhr, textstatus, errorthrown) {
                showApproveResultDialog('网络错误', 'icon-warning-sign',
                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
            }
        });
    }
    function showApproveResultDialog(header, header_icon, msg, width) {
        $("#approve-result-dialog").append(msg);
        var title_html_str = $.parseStr('<div class="dialog_title"><li class="%s"></li> %s</div>', header_icon, header);
        var edit_dialog = $("#approve-result-dialog").removeClass('hide').dialog({
            modal: true,
            width: width,
            resizable: true,
            title: title_html_str,
            title_html: true,
            closeOnEscape: false,
            open: function (event, ui) {
                $(".ui-dialog-titlebar-close").hide();
            },
            buttons: [
                {
                    text: "确定",
                    "class": "btn btn-primary btn-xs",
                    click: function () {
                        $("#approve-result-dialog").empty();
                        $("#approve-result-dialog").dialog('destroy')
                    }
                }
            ],
            close: function () {
                $("#approve-result-dialog").empty();
                $("#approve-result-dialog").dialog('destroy')
            }
        });
    }
    
    
    function approveReject() {
        var url = "oa/approve_reject";
        var dialog_width = Math.min(Math.round(window.screen.width * 0.7), 900);
        try {
            $("#reject-msg-dialog").empty();
            $("#reject-msg-dialog").append(createOperateMsgForm('Tips: 拒绝理由请不要超过100个字符'));
            var dialog = $("#reject-msg-dialog").removeClass('hide').dialog({
                modal: true,
                width: dialog_width,
                height: 250,
                title: '<div style="color: DodgerBlue; padding: 4px; height: 28px; font-size: 14px; font-weight: bold"><li class="icon-user"></li> 拒绝理由</div>',
                title_html: true,
                closeOnEscape: false,
                open: function (event, ui) {
                    $(".ui-dialog-titlebar-close").hide();
                },
                buttons: [
                    {
                        id: "reject-msg-submit",
                        text: "提交",
                        "class": "btn btn-primary btn-xs",
                        click: function (e) {
                            var Me = this;
                            try {
                                var this_form = $("#reject-msg-dialog").find("form");
                                var postData = this_form.serializeArray();
                                var msg = "";
                                for (var i in postData) {
                                    if (postData[i]['name'] == 'msg') {
                                        if (postData[i]['value'].length >= 100) {
                                            showCommonNoticeDialog('拒绝理由错误', 'icon-warning-sign',
                                                    generateNoticeMsg('拒绝理由不能超过100个字符'), 300);
                                            return;
                                        } else if (postData[i]['value'].length == 0) {
                                            showCommonNoticeDialog('拒绝理由错误', 'icon-warning-sign',
                                                    generateNoticeMsg('拒绝理由不能为空'), 300);
                                            return;
                                        } else {
                                            msg = postData[i]['value'];
                                            break;
                                        }
                                    }
                                }
                                approveProxy(url, msg, "拒绝");
                                e.preventDefault(); //STOP default action
                                $(this).dialog("close");
                            } catch (e) {
                                showCommonNoticeDialog('网络错误', 'icon-warning-sign',
                                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
                            }
                        }
                    },
                    {
                        id: "reject-msg-cancel",
                        text: "取消",
                        "class": "btn btn-xs",
                        click: function () {
                            $(this).dialog("close");
                        }
                    }
                ]
            });
        } catch (e) {
            showCommonNoticeDialog('网络错误', 'icon-warning-sign',
                    generateNoticeMsg('网络错误，请刷新后重试!'), 300);
        }
    }

    function approveBack() {
        var url = "oa/approve_back";
        var dialog_width = Math.min(Math.round(window.screen.width * 0.7), 900);
        try {
            $("#back-msg-dialog").empty();
            $("#back-msg-dialog").append(createOperateMsgForm('Tips: 退回理由请不要超过100个字符'));
            var dialog = $("#back-msg-dialog").removeClass('hide').dialog({
                modal: true,
                width: dialog_width,
                height: 250,
                title: '<div style="color: DodgerBlue; padding: 4px; height: 28px; font-size: 14px; font-weight: bold"><li class="icon-user"></li> 退回理由</div>',
                title_html: true,
                closeOnEscape: false,
                open: function (event, ui) {
                    $(".ui-dialog-titlebar-close").hide();
                },
                buttons: [
                    {
                        id: "back-msg-submit",
                        text: "提交",
                        "class": "btn btn-primary btn-xs",
                        click: function (e) {
                            var Me = this;
                            try {
                                var this_form = $("#back-msg-dialog").find("form");
                                var postData = this_form.serializeArray();
                                var msg = "";
                                for (var i in postData) {
                                    if (postData[i]['name'] == 'msg') {
                                        if (postData[i]['value'].length >= 100) {
                                            showCommonNoticeDialog('退回理由错误', 'icon-warning-sign',
                                                    generateNoticeMsg('退回理由不能超过100个字符'), 300);
                                            return;
                                        } else if (postData[i]['value'].length == 100) {
                                            showCommonNoticeDialog('退回理由错误', 'icon-warning-sign',
                                                    generateNoticeMsg('退回理由不能为空'), 300);
                                            return;
                                        } else {
                                            msg = postData[i]['value'];
                                            break;
                                        }
                                    }
                                }
                                approveProxy(url, msg, "退回");
                                e.preventDefault(); //STOP default action
                                $(this).dialog("close");
                            } catch (e) {
                                showCommonNoticeDialog('网络错误', 'icon-warning-sign',
                                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
                            }
                        }
                    },
                    {
                        id: "back-msg-cancel",
                        text: "取消",
                        "class": "btn btn-xs",
                        click: function () {
                            $(this).dialog("close");
                        }
                    }
                ]
            });
        } catch (e) {
            showCommonNoticeDialog('网络错误', 'icon-warning-sign',
                    generateNoticeMsg('网络错误，请刷新后重试!'), 300);
        }
    }

    function approveEndorse() {
        var url = "oa/approve_endorse";
        var dialog_width = Math.min(Math.round(window.screen.width * 0.7), 900);
        try {
            $("#endorse-msg-dialog").empty();
            $("#endorse-msg-dialog").append(createEndorseMsgForm('Tips: 请输入加签RTX_ID'));
            var dialog = $("#endorse-msg-dialog").removeClass('hide').dialog({
                modal: true,
                width: dialog_width,
                height: 300,
                title: '<div style="color: DodgerBlue; padding: 4px; height: 28px; font-size: 14px; font-weight: bold"><li class="icon-user"></li> 加签理由</div>',
                title_html: true,
                closeOnEscape: false,
                open: function (event, ui) {
                    $(".ui-dialog-titlebar-close").hide();
                },
                buttons: [
                    {
                        id: "endorse-msg-submit",
                        text: "提交",
                        "class": "btn btn-primary btn-xs",
                        click: function (e) {
                            var Me = this;
                            try {
                                var this_form = $("#endorse-msg-dialog").find("form");

                                var postData = this_form.serializeArray();
                                var msg = "";
                                if( $("#rtx_id").val() == ''){
                                	showCommonNoticeDialog('加签错误', 'icon-warning-sign',
                                                    generateNoticeMsg('加签对象不能为空'), 300);
                                    return;
                                }
                                for (var i in postData) {
                                    if (postData[i]['name'] == 'msg') {
                                        if (postData[i]['value'].length >= 100) {
                                            showCommonNoticeDialog('加签错误', 'icon-warning-sign',
                                                    generateNoticeMsg('加签理由不能超过100个字符'), 300);
                                            return;
                                        } else if (postData[i]['value'].length == 0) {
                                            showCommonNoticeDialog('加签错误', 'icon-warning-sign',
                                                    generateNoticeMsg('加签理由不能为空'), 300);
                                            return;
                                        } else {
                                            msg = postData[i]['value'];
                                            break;
                                        }
                                    }
                                }
                                approveProxy(url, msg, "加签", $("#rtx_id").val());
                                e.preventDefault(); //STOP default action
                                $(this).dialog("close");
                            } catch (e) {
                                showCommonNoticeDialog('网络错误', 'icon-warning-sign',
                                        generateNoticeMsg('网络错误，请刷新后重试!'), 300);
                            }
                        }
                    },
                    {
                        id: "endorse-msg-cancel",
                        text: "取消",
                        "class": "btn btn-xs",
                        click: function () {
                            $(this).dialog("close");
                        }
                    }
                ]
            });
        } catch (e) {
            showCommonNoticeDialog('网络错误', 'icon-warning-sign',
                    generateNoticeMsg('网络错误，请刷新后重试!'), 300);
        }
    }
    
    function createOperateMsgForm(msg) {
        var tips = msg;
        var form = '<form style="width: 100%; background-color: white"> ';
        form += '<div>';
        form += $.parseStr('<textarea class="form-control" name="msg" style="height: 100px;" placeholder="%s"></textarea>', tips);
        form += '</div>';
        form += '</form>';
        return form;
    }

    //  加签需要填写rtx_id
    function createEndorseMsgForm(msg) {
        var tips = msg;
        var form = '<form style="width: 100%; background-color: white"> ';

        form += '<div class="form-group">';
        form += '<label>加签给：</label>';
        form += $.parseStr('<input class="form-control" id="rtx_id" placeholder="%s">', "请输入rtx_id, 不能为空");
        form += '</div>';
        form += '<div class="space-4"></div>';
        form += '<div>';
        form += $.parseStr('<textarea class="form-control" name="msg" style="height: 100px;" placeholder="%s"></textarea>', tips);
        form += '</div>';
        form += '</form>';
        return form;
    }
    
    function payAmount(){
    	payAmount = $("#payAmount").val();
    	ratify = $("#ratify").val();
    	if(payAmount <= 0 || payAmount==''){
    		alert("支付金额不能等于0");
    		$("#payAmount").val("");
    		return false;
    	}
    	if(payAmount > ratify){
    		alert("支付金额不能大于核定总金额");
    		$("#payAmount").val("");
    		return false;
    	}
    }
</script>
